<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: tech | ã•ã‚ˆãªã‚‰ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ]]></title>
  <link href="http://blog.kenjiskywalker.org/blog/categories/tech/atom.xml" rel="self"/>
  <link href="http://blog.kenjiskywalker.org/"/>
  <updated>2016-07-12T12:05:31+09:00</updated>
  <id>http://blog.kenjiskywalker.org/</id>
  <author>
    <name><![CDATA[kenjiskywalker]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[ç‰¹å®šã®Roleã®EIPãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹EC2ãŒTerminateã•ã‚ŒãŸæ™‚ã«æ–°ã—ãèµ·å‹•ã—ãŸEC2ã«æµ®ã„ãŸEIPã‚’ä»˜ä¸ã•ã›ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2016/07/08/samsara-eip/"/>
    <updated>2016-07-08T13:32:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2016/07/08/samsara-eip</id>
    <content type="html"><![CDATA[<p>ä»¶ã®é€šã‚Š</p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="ja" dir="ltr"><a href="https://twitter.com/kenjiskywalker">@kenjiskywalker</a> ãã‚“ãªä»•çµ„ã¿ã‚ã‚‹ã®ï¼Ÿ</p>&mdash; ãã®ã£ã¤ (Naotoshi Seo) (@sonots) <a href="https://twitter.com/sonots/status/751219867785711616">July 8, 2016</a></blockquote>


<p> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="ja" dir="ltr"><a href="https://twitter.com/kenjiskywalker">@kenjiskywalker</a> ã‚¯ãƒ¬ã‚¯ãƒ¬</p>&mdash; ãã®ã£ã¤ (Naotoshi Seo) (@sonots) <a href="https://twitter.com/sonots/status/751220071335235585">July 8, 2016</a></blockquote>


<p> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>ä»Šè¦‹ç›´ã—ãŸã‚‰çµæ§‹ã²ã©ã„æ„Ÿã˜ã ã£ãŸã‘ã©ä¸€æ—¦å…¬é–‹ã—ã¦ãŠãã€‚<br/>
AWS SDK for Rubyã‚’åˆ©ç”¨ã—ã¦ã‚‚ã„ã„ã—ã€ã“ã‚Œãã‚‰ã„ãªã‚‰goã§æ›¸ã„ã¦ã‚‚è‰¯ã„ã‚¹ã­ã€‚</p>

<h3>ä»•çµ„ã¿</h3>

<ul>
<li><code>Role</code>  - web, db, app, etc&hellip;</li>
<li><code>Stage</code> - development, staging, production, etc&hellip;</li>
</ul>


<p><code>EC2</code>ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãã‚Œãã‚Œã«<a href="http://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/Using_Tags.html">ã‚¿ã‚°</a>ã®è¨­å®šã‚’å…¥ã‚Œã¦ã„ã‚‹ã€‚<br/>
ãã‚Œãã‚Œã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯<a href="http://docs.aws.amazon.com/ja_jp/AutoScaling/latest/DeveloperGuide/WhatIsAutoScaling.html">AutoScalingGroup</a>ç®¡ç†ä¸‹ã«ã‚ã‚Šã€<br/>
ä¸Šè¨˜ã‚¿ã‚°ã‚‚ãã‚Œãã‚Œã®AutoScalingGroupã«ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•æ™‚ã«ä»˜ä¸ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚</p>

<h4>èµ·å‹•æ™‚ã«æµ®ã„ãŸEIPã‚’ã‚¢ã‚µã‚¤ãƒ³ã•ã›ãŸã„</h4>

<p>Ref: <a href="http://qiita.com/toshihirock/items/81d6612511f0d1f5db77">Qiita:AmazonLinuxã®cloud-initã«ã¤ã„ã¦ã®èª¿æŸ»ãƒ¡ãƒ¢</a></p>

<p><code>cloud-init</code>ã®ã„ã„æ„Ÿã˜ã®ã‚ªãƒ•ã‚£ã‚·ãƒ£ãƒ«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã£ã¦ã©ã“ã«ã‚ã‚‹ã‚“ã &hellip;</p>

<ul>
<li>/var/lib/cloud/scripts/per-boot/004_assign-elastic-ip.rb</li>
</ul>


<pre><code class="rb">#!/usr/bin/env ruby

#
# åŸºæœ¬çš„ã« å„Role ã« EIP ã‚’ä»˜ä¸ã™ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ 2å° æ¯
# 
#

INSTANCEID  = `curl -s http://169.254.169.254/latest/meta-data/instance-id/`

REGION      = 'ap-northeast-1'
ROLE        = `aws --region #{REGION} ec2 describe-instances \
                 --instance-ids #{INSTANCEID} \
                 --output text \
                 --query 'Reservations[].Instances[].Tags[?Key==\`Role\`].[Value]' \
                 `.chomp
STAGE       = `aws --region #{REGION} ec2 describe-instances \
                 --instance-ids #{INSTANCEID} \
                 --output text \
                 --query 'Reservations[].Instances[].Tags[?Key==\`Stage\`].[Value]' \
                 `.chomp

# foo, barä»¥å¤–ã¯EIPã®ä»˜ä¸ã¯ãªã„ã®ã§ä¸€æ—¦ã“ã®æ¡ä»¶ã‚’è¨­å®šã™ã‚‹
exit 0 unless ROLE == 'foo' || ROLE == 'bar'

# æµ®ã„ãŸEIPã‚’å…¥ã‚Œã‚‹å¤‰æ•°
elasticip_allocation_ids = []

# ROLE ã¨ STAGE æ¯ã«ä¿æŒã—ã¦ã„ã‚‹ EIP ã¯é•ã†
# TODO: hash or json
case ROLE
when 'foo'
  if STAGE == 'development'
    elasticip_allocation_ids = ['eipalloc-XXXXXXXX', 'eipalloc-XXXXXXXX']
  elsif STAGE == 'staging'
    elasticip_allocation_ids = ['eipalloc-XXXXXXXX', 'eipalloc-XXXXXXXX']
  else
    exit 0
  end
when 'bar'
  if STAGE == 'production'
    elasticip_allocation_ids = ['eipalloc-XXXXXXXX']
  elsif STAGE == 'staging'
    elasticip_allocation_ids = ['eipalloc-XXXXXXXX']
  else
    exit 0
  end
when 'baz'
  if STAGE == 'production'
    elasticip_allocation_ids = ['eipalloc-XXXXXXXX']
  elsif STAGE == 'staging'
    elasticip_allocation_ids = ['eipalloc-XXXXXXXX']
  else
    exit 0
  end
else
  exit 0
end

elasticip_allocation_ids.each do |eip_id|
  # å¯¾è±¡ã®EIPã«EC2ãŒç´ä»˜ã„ã¦ã„ã‚‹ã‹ç¢ºèª(æµ®ã„ãŸEIPã‚’æ¢ã™)
  assigned_instance_id = `aws --region #{REGION} ec2 describe-addresses \
                            --allocation-ids #{eip_id} \
                            | jq '.Addresses[].InstanceId' \
                            `.chomp

  # æµ®ã„ãŸEIPãŒã‚ã‚Œã°ä»˜ä¸ã™ã‚‹å‡¦ç†ã¸ç§»ã‚‹
  next unless assigned_instance_id == 'null'

  # EIPã‚’ä»˜ä¸ã™ã‚‹
  `aws --region #{REGION} ec2 associate-address \
     --allocation-id #{eip_id} \
     --instance-id #{INSTANCEID}`
  puts "COMPLETE: associate-address --allocation-id #{eip_id} --instance-id #{INSTANCEID}"
  exit 0
end

puts "CANNOT ASSOCIATE EIP to `hostname`"
exit 1
</code></pre>

<p>ã¨ã„ã†æ„Ÿã˜ã§<code>/var/lib/cloud/scripts/per-boot/</code>é…ä¸‹ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç½®ã„ã¦ã„ã‚‹ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[å•é¡ŒãŒã‚ã£ãŸã®ã§fluentdã§sigdumpã‚’ä½¿ã„stactraceã—ã¦mackerel-client-rubyã«PRã—ãŸè©±]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2016/07/08/mackerel-meets-fluentd-and-debug-it/"/>
    <updated>2016-07-08T12:45:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2016/07/08/mackerel-meets-fluentd-and-debug-it</id>
    <content type="html"><![CDATA[<p>ã¿ã‚“ãªã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒãŒå®‰å®šã—ã¦ã„ã‚‹ã®ã‹..<br/>
æˆ‘ã€…ã®ä¸–ç•Œç·šã«ãƒã‚¤ã‚ºãŒæ··åœ¨ã—ã¦ã—ã¾ã£ã¦ã„ã‚‹ã®ã‹&hellip;</p>

<p>ãã‚Œã‚’èª¿ã¹ã‚‹ã™ã¹ã¯ãªã„ãŒã€ä¸‹è¨˜ã®ã‚ˆã†ãªå•é¡ŒãŒã‚ã£ãŸã€‚</p>

<ul>
<li><code>mackerel</code>ã§çªç„¶ã‚°ãƒ©ãƒ•ãŒè¡¨ç¤ºã•ã‚Œãªããªã‚‹</li>
<li>ãã®ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã®ã¯<code>fluent-plugin-mackerel</code>ã‚’åˆ©ç”¨ã—ã¦<code>fluentd</code>çµŒç”±ã§ä½œæˆã—ã¦ã„ã‚‹</li>
<li>ãã®<code>td-agent</code>ã¯å†èµ·å‹•ã—ã‚ˆã†ã¨ã™ã‚‹ã¨<code>Timeout error</code>ã«ãªã‚‹</li>
</ul>


<p>ã¨ã„ã†ã“ã¨ã§æ€ªå¥‡ç¾è±¡ã‚’è§£æ±ºã™ã‚‹ç‚ºã«ã‚„ã£ãŸã“ã¨ã‚’ãƒ¡ãƒ¢</p>

<h3>æ„šç›´ã«<code>td-agent</code>ã®å†èµ·å‹•ã‚’è©¦ã¿ã¦ã¿ã‚‹</h3>

<pre><code>[watashi@example-host ~]$ 
[watashi@example-host ~]$ 
[watashi@example-host ~]$ sudo service td-agent restart
Restarting td-agent:

Timeout error occurred trying to stop td-agent...                                          [  OK  ]
[watashi@example-host ~]$ 
</code></pre>

<p>ãƒ€ãƒ¡ã‚„</p>

<p>fluentdã®ã‚³ãƒŸãƒƒã‚¿ãƒ¼ã®<a href="https://twitter.com/sonots">@sonots</a>ã•ã‚“ã«</p>

<ul>
<li>ãƒ­ã‚°ã¯å‡ºãªã„</li>
<li>ãƒ‡ãƒ¼ãƒ¢ãƒ³ã¯ç”Ÿãã¦ã„ã‚‹</li>
</ul>


<p>ãã‚“ãªç¾è±¡ã«å‡ºä¼šã£ãŸã“ã¨ãªã„ï¼Ÿã¨èã„ãŸã¨ã“ã‚ <br/>
fluentdã«ã¯<a href="https://github.com/frsyuki/sigdump">sigdump</a>ãŒå…¥ã£ã¦ã„ã‚‹ã‹ã‚‰<br/>
ãã“ã§stacktraceã‚’è¿½ã£ã¦ã¿ã‚Œã°ã€ã¨æ„è­˜ã®é«˜ã„ãŠè¿”äº‹ã‚’é ‚ã„ãŸã®ã§å®Ÿè¡Œã—ã¦ã¿ã‚‹ã€‚</p>

<h4>kill -CONT</h4>

<p><a href="https://github.com/frsyuki/sigdump#usage">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a>ã«æ›¸ã„ã¦ã‚ã‚‹ã‚ˆã†ã«<code>CONT</code>ã®ã‚·ã‚°ãƒŠãƒ«ã‚’é€ã‚‹</p>

<pre><code>[watashi@example-host ~]$ ps auxwwwf | grep td-agent
td-agent  7779  0.0  0.3 241756 26700 ?        Sl   May27   0:00 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid
td-agent  7915  0.3  3.7 838976 288956 ?       Sl   May27 225:44  \_ /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid
[watashi@example-host ~]$ 
[watashi@example-host ~]$ sudo kill -CONT 7915
[watashi@example-host ~]$ 
[watashi@example-host ~]$ ps auxwwwf | grep td-agent
td-agent  7779  0.0  0.3 241756 26836 ?        Sl   May27   0:00 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid
td-agent  7915  0.3  3.7 838976 288956 ?       Sl   May27 225:44  \_ /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid
[watashi@example-host ~]$
</code></pre>

<h4>sigdumpãŒã§ãã‚ãŒã£ã¦ã„ã‚‹</h4>

<pre><code>[watashi@example-host ~]$ ls -la /tmp/
total 1048
-rw-rw-rw-  1 td-agent td-agent    5937 Jul  7 10:51 sigdump-7915.log
[watashi@example-host ~]$
</code></pre>

<h4>sigdumpã®ä¸­èº«ã‚’è¦‹ã¦ã¿ã‚‹</h4>

<pre><code>[watashi@example-host ~]$ sudo view /tmp/sigdump-7915.log
Sigdump at 2016-07-07 10:52:00 +0900 process 7915 (/usr/sbin/td-agent)
  Thread #&lt;Thread:0x007fce4f19e658&gt; status=run priority=0
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:39:in `backtrace'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:39:in `dump_backtrace'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:25:in `block in dump_all_thread_backtrace'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:24:in `each'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:24:in `dump_all_thread_backtrace'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:16:in `block in dump'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:119:in `open'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:119:in `_open_dump_path'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:14:in `dump'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:7:in `block in setup'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/agent.rb:102:in `call'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/agent.rb:102:in `join'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/agent.rb:102:in `block in shutdown'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/agent.rb:102:in `each'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/agent.rb:102:in `shutdown'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/root_agent.rb:131:in `block in shutdown'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/root_agent.rb:130:in `each'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/root_agent.rb:130:in `shutdown'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/engine.rb:229:in `shutdown'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/engine.rb:200:in `run'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/supervisor.rb:597:in `run_engine'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/supervisor.rb:148:in `block in start'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/supervisor.rb:352:in `call'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/supervisor.rb:352:in `main_process'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/supervisor.rb:325:in `block in supervise'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/supervisor.rb:324:in `fork'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/supervisor.rb:324:in `supervise'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/supervisor.rb:142:in `start'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/command/fluentd.rb:171:in `&lt;top (required)&gt;'
      /opt/td-agent/embedded/lib/ruby/site_ruby/2.1.0/rubygems/core_ext/kernel_require.rb:54:in `require'
      /opt/td-agent/embedded/lib/ruby/site_ruby/2.1.0/rubygems/core_ext/kernel_require.rb:54:in `require'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/bin/fluentd:6:in `&lt;top (required)&gt;'
      /opt/td-agent/embedded/bin/fluentd:23:in `load'
      /opt/td-agent/embedded/bin/fluentd:23:in `&lt;top (required)&gt;'
      /usr/sbin/td-agent:7:in `load'
      /usr/sbin/td-agent:7:in `&lt;main&gt;'
  Thread #&lt;Thread:0x007fce4f1910c0&gt; status=sleep priority=0
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/output.rb:165:in `sleep'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/output.rb:165:in `wait'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/output.rb:165:in `cond_wait'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/output.rb:149:in `run'
  Thread #&lt;Thread:0x007fce4f192880&gt; status=sleep priority=0
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/cool.io-1.4.2/lib/cool.io/loop.rb:88:in `run_once'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/cool.io-1.4.2/lib/cool.io/loop.rb:88:in `run'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/plugin/out_forward.rb:185:in `run'
  Thread #&lt;Thread:0x007fce4f18eb40&gt; status=sleep priority=0
      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:923:in `connect'
      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:923:in `block in connect'
      /opt/td-agent/embedded/lib/ruby/2.1.0/timeout.rb:75:in `timeout'
      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:923:in `connect'
      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:863:in `do_start'
      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:852:in `start'
      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:1375:in `request'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/adapter/net_http.rb:82:in `perform_request'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/adapter/net_http.rb:40:in `block in call'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/adapter/net_http.rb:87:in `with_net_http_connection'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/adapter/net_http.rb:32:in `call'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/rack_builder.rb:139:in `build_response'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/connection.rb:377:in `run_request'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/connection.rb:177:in `post'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/mackerel-client-0.1.0/lib/mackerel/client.rb:108:in `post_service_metrics'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluent-plugin-mackerel-0.1.3/lib/fluent/plugin/out_mackerel.rb:161:in `send'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluent-plugin-mackerel-0.1.3/lib/fluent/plugin/out_mackerel.rb:151:in `write'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/buffer.rb:345:in `write_chunk'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/buffer.rb:324:in `pop'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/output.rb:329:in `try_flush'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/output.rb:140:in `run'

  ...

    GC stat:
      count: 59808
      heap_used: 261
      heap_length: 261
      heap_increment: 0
      heap_live_slot: 105333
      heap_free_slot: 1061
      heap_final_slot: 0
      heap_swept_slot: 26253
      heap_eden_page_length: 261
      heap_tomb_page_length: 0
      total_allocated_object: 2536413815
      total_freed_object: 2536308482
      malloc_increase: 3756384
      malloc_limit: 16777216
      minor_gc_count: 58261
      major_gc_count: 1547
      remembered_shady_object: 2178
      remembered_shady_object_limit: 2276
      old_object: 62144
      old_object_limit: 112630
      oldmalloc_increase: 3800672
      oldmalloc_limit: 16777216
  Built-in objects:
   106,394: TOTAL
    47,172: T_STRING
    21,189: T_DATA
    16,574: T_ARRAY
     6,805: T_NODE
     3,221: T_OBJECT
     3,064: T_CLASS
     2,418: T_HASH
     1,910: T_FILE
     1,300: FREE
       736: T_ICLASS
       719: T_REGEXP
       701: T_STRUCT
       287: T_MATCH
       168: T_MODULE
        61: T_BIGNUM
        59: T_RATIONAL
         9: T_FLOAT
         1: T_COMPLEX
[watashi@example-host ~]$
</code></pre>

<h4>ã‚ˆãã‚ã‹ã‚‰ã‚“ãŒèª­ã‚“ã§è¦‹ã‚‹</h4>

<pre><code>  Thread #&lt;Thread:0x007fce4f18f1a8&gt; status=sleep priority=0
      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:923:in `connect'
      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:923:in `block in connect'
      /opt/td-agent/embedded/lib/ruby/2.1.0/timeout.rb:75:in `timeout'
      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:923:in `connect'
      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:863:in `do_start'
      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:852:in `start'
      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:1375:in `request'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/adapter/net_http.rb:82:in `perform_request'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/adapter/net_http.rb:40:in `block in call'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/adapter/net_http.rb:87:in `with_net_http_connection'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/adapter/net_http.rb:32:in `call'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/rack_builder.rb:139:in `build_response'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/connection.rb:377:in `run_request'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/connection.rb:177:in `post'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/mackerel-client-0.1.0/lib/mackerel/client.rb:108:in `post_service_metrics'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluent-plugin-mackerel-0.1.3/lib/fluent/plugin/out_mackerel.rb:161:in `send'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluent-plugin-mackerel-0.1.3/lib/fluent/plugin/out_mackerel.rb:151:in `write'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/buffer.rb:345:in `write_chunk'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/buffer.rb:324:in `pop'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/output.rb:329:in `try_flush'
      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/output.rb:140:in `run'
</code></pre>

<p><code>fluent-plugin-mackerel</code>ã¨<code>faraday</code>ã¨ã„ã†æ–‡å­—åˆ—ãŒè¦‹ãˆã‚‹</p>

<h3>mackerel-client-rubyã«PRã‚’é€ã‚‹</h3>

<p><a href="https://github.com/mackerelio/mackerel-client-ruby/pull/24">pull/24</a>ã®ã‚„ã‚Šã¨ã‚ŠãŒãã‚Œ</p>

<p><code>faraday</code>ã«<code>timeout</code>ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒãªã‹ã£ãŸã®ã§è¶³ã—ãŸã€‚</p>

<h2>å¾Œå‡¦ç†</h2>

<ul>
<li>å¯¾è±¡ã‚µãƒ¼ãƒã§<code>mackerel-client-ruby</code>ã‚’ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—</li>
</ul>


<pre><code>[watashi@example-host ~]$
[watashi@example-host ~]$ sudo /opt/td-agent/embedded/bin/gem update mackerel-client
Updating installed gems
Updating mackerel-client
Fetching: mackerel-client-0.1.1.gem (100%)
Successfully installed mackerel-client-0.1.1
Parsing documentation for mackerel-client-0.1.1
Installing ri documentation for mackerel-client-0.1.1
Installing darkfish documentation for mackerel-client-0.1.1
Done installing documentation for mackerel-client after 0 seconds
Parsing documentation for mackerel-client-0.1.1
Done installing documentation for mackerel-client after 0 seconds
Gems updated: mackerel-client
[watashi@example-host ~]$
</code></pre>

<ul>
<li>å¯¾è±¡ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’å§‹æœ«ã—ã¦ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚’èµ·å‹•</li>
</ul>


<pre><code>[watashi@example-host ~]$ kill 7915
[watashi@example-host ~]$ ps auxwwwf | grep td-agent
td-agent  7779  0.0  0.3 241756 26836 ?        Sl   May27   0:00 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid
td-agent  7915  0.3  3.7 838976 288956 ?       Sl   May27 225:44  \_ /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid
[watashi@example-host ~]$
[watashi@example-host ~]$ kill 7779
[watashi@example-host ~]$ ps auxwwwf | grep td-agent
td-agent  7779  0.0  0.3 241756 26836 ?        Sl   May27   0:00 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid
td-agent  7915  0.3  3.7 838976 288956 ?       Sl   May27 225:44  \_ /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid
[watashi@example-host ~]$
[watashi@example-host ~]$ kill -9 7915
[watashi@example-host ~]$ kill -9 7779
[watashi@example-host ~]$ ps auxwwwf | grep td-agent
[watashi@example-host ~]$
[watashi@example-host ~]$
[watashi@example-host ~]$ sudo  service td-agent start
Starting td-agent:                                         [  OK  ]
[watashi@example-host ~]$
</code></pre>

<p>ãƒ­ã‚°ã‚„<code>mackerel</code>ãªã©ã§å•é¡Œãªãå‡ºåŠ›ãŒã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹ã€‚</p>

<p>ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã•ã›ã¦ã‚‚ã‚‰ã£ã¦ã„ã‚‹å´ã‚‚ã“ã®ã‚ˆã†ã«åœ°å‘³ãªã¨ã“ã‚ã§è²¢çŒ®ã§ãã‚‹ã®ã§<br/>
ä½•ã‹ã‚ã£ãŸã‚‰è‰²ã€…ã¨ã‚„ã£ã¦ã¿ã‚ˆã†ğŸ’ª</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Slackã®APIã§channel.listã‚„channel.infoã§å–ã‚Œãªã„æ™‚ã¯group.listã‚„group.infoã§å–ã‚ã†]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2016/02/25/slack-api-channel-to-group/"/>
    <updated>2016-02-25T14:18:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2016/02/25/slack-api-channel-to-group</id>
    <content type="html"><![CDATA[<p>ä»¥ä¸Šã§ã™ã€‚(ã©ã“ã‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè½ã¡ã¦ã‚‹ã‹ãª)</p>
]]></content>
  </entry>
  
</feed>
