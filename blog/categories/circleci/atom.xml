<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: circleci | さよならインターネット]]></title>
  <link href="http://blog.kenjiskywalker.org/blog/categories/circleci/atom.xml" rel="self"/>
  <link href="http://blog.kenjiskywalker.org/"/>
  <updated>2016-07-08T16:37:02+09:00</updated>
  <id>http://blog.kenjiskywalker.org/</id>
  <author>
    <name><![CDATA[kenjiskywalker]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[CircleCIでDockerコンテナに対してansibleを実行しserverspecでテストをする]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2014/11/13/circleci-docker-ansible-serverspec/"/>
    <updated>2014-11-13T21:11:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2014/11/13/circleci-docker-ansible-serverspec</id>
    <content type="html"><![CDATA[<h3>参考</h3>

<p><a href="https://speakerdeck.com/naoya/kaizen-platform-inc-niokeruyun-yong-zi-dong-hua">KAIZEN platform Inc. における運用自動化 - Speaker Deck</a><br/>
<a href="https://circleci.com/docs/docker">Continous Integration and Delivery with Docker - CircleCI</a></p>

<h2>TL;DR</h2>

<p>CircleCI上でDockerコンテナを立て、<br/>
そのコンテナに対してプロビジョニングを行い、<br/>
プロビジョニング後のコンテナに対してテストを行う</p>

<h2>DockerコンテナにAnsibleを実行する</h2>

<p>コミットする度にDockerのimageをpullするのは時間がもったいないので<br/>
<code>cache_directories</code>を利用し、imageをexportしておき<br/>
実行時にimportするようにすると多少速くなる。</p>

<pre><code>.
├── Dockerfile
├── ansible/
└── circle.yml
</code></pre>

<ul>
<li>Dockerfile</li>
</ul>


<pre><code>FROM kenjiskywalker/dockerfile-centos-ansible
</code></pre>

<ul>
<li>circle.yml</li>
</ul>


<pre><code>machine:
  services:
    - docker

dependencies:
  pre:
    - if [[ -e docker_ansible_image.tar ]]; then cat docker_ansible_image.tar | docker import - kenjiskywalker/dockerfile-centos-ansible ; docker load --input docker_ansible_image.tar ; else docker build . ; docker save -o docker_ansible_image.tar kenjiskywalker/dockerfile-centos-ansible ; fi

  cache_directories:
    - "docker_ansible_image.tar"

test:
  post:
    - docker run -v `pwd`/ansible:/ansible kenjiskywalker/dockerfile-centos-ansible ansible-playbook /ansible/ci.yml -i /ansible/inventory_localhost -c local
</code></pre>

<p>こんな感じの設定ファイルを置いておくと<code>ansible</code>ディレクトリをマウントし<br/>
Dockerコンテナがansibleを実行できる状態であればDockerコンテナに対して<br/>
ansibleが実行できる。この続きにServerspecを記述することで</p>

<ol>
<li>リポジトリにansibleのファイルをコミットする</li>
<li>CircleCI上にてDockerコンテナを起動</li>
<li>Dockerコンテナに対してansibleでプロビジョニング</li>
<li>そのプロビジョニング結果をServerspecでテストをする</li>
</ol>


<p>のようなことができる。</p>

<h2>wercker</h2>

<p>werckerでも同じようなことができる。<br/>
CircleCIと同様にファイルをキャッシュするには<br/>
<code>$WERCKER_CACHE_DIR</code>を利用すればよいかと。</p>

<ul>
<li>wercker.yml</li>
</ul>


<pre><code>box: wercker-labs/docker
build:
  steps:
    - script:
        name: docker build
        code: docker build .
    - script:
        name: docker run
        code: docker run -v `pwd`/ansible:/ansible dockerfile/ansible ansible-playbook /ansible/ci.yml -i /ansible/inventory_localhost -c local
</code></pre>

<p>以上、メモです。</p>
]]></content>
  </entry>
  
</feed>
