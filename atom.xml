<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[さよならインターネット]]></title>
  <link href="http://blog.kenjiskywalker.org/atom.xml" rel="self"/>
  <link href="http://blog.kenjiskywalker.org/"/>
  <updated>2016-07-12T12:05:31+09:00</updated>
  <id>http://blog.kenjiskywalker.org/</id>
  <author>
    <name><![CDATA[kenjiskywalker]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[EC2のStatus Checkの変異をSNSを通してPagerDutyからSlackへ通知させる]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2016/07/12/ec2-status-fail-check/"/>
    <updated>2016-07-12T11:44:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2016/07/12/ec2-status-fail-check</id>
    <content type="html"><![CDATA[<p>EC2がちょくちょくStatus ChecksがコケてTerminateされていたので<br/>
CloudWatchで見ているStatus Checkの値の変異を見て<br/>
SNSに通知をさせている。</p>

<p><code>SNS &lt;-&gt; PagerDuty &lt;-&gt; Slack</code></p>

<h4>参考URL</h4>

<ul>
<li><a href="http://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/monitoring-system-instance-status-check.html">インスタンスのステータスチェック</a></li>
<li><a href="https://www.pagerduty.com/docs/guides/aws-cloudwatch-integration-guide/">AWS CloudWatch Integration Guide:PagerDuty</a></li>
<li><a href="https://www.pagerduty.com/docs/guides/slack-integration-guide/">Slack Integration Guide:PagerDuty</a></li>
</ul>


<p>一番良いのはEC2が立ち上がってきた時に自分自身に下記設定を導入し<br/>
自分が消える時に設定を削除するのが好ましいが、所々事情があり<br/>
下記のようなスクリプトを特定のEC2で回している。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="n">region</span> <span class="o">=</span> <span class="s1">&#39;REGION&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># インスタンスID一覧を取得する ( --max-items XXX # インスタンス数次第 )</span>
</span><span class='line'><span class="n">instance_ids</span> <span class="o">=</span> <span class="sb">`aws --region </span><span class="si">#{</span><span class="n">region</span><span class="si">}</span><span class="sb"> ec2 describe-instances \</span>
</span><span class='line'><span class="sb">                    --max-items XXX \</span>
</span><span class='line'><span class="sb">                    --filters Name=tag-key,Values=Name \</span>
</span><span class='line'><span class="sb">                    | jq -r &#39;.Reservations[].Instances[].InstanceId&#39;</span>
</span><span class='line'><span class="sb">                    `</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># CloudWatchでStatusCheckFailed_Checkが設定されているインスタンスID一覧 ( --max-items XXX # インスタンス数次第 )</span>
</span><span class='line'><span class="n">checked_instance_ids</span> <span class="o">=</span> <span class="sb">`aws --region </span><span class="si">#{</span><span class="n">region</span><span class="si">}</span><span class="sb"> cloudwatch describe-alarms \</span>
</span><span class='line'><span class="sb">                            --max-items XXX \</span>
</span><span class='line'><span class="sb">                            | jq -r &#39;.MetricAlarms[].AlarmName&#39; \</span>
</span><span class='line'><span class="sb">                            | grep &#39;StatusCheckFailed_Check&#39; \</span>
</span><span class='line'><span class="sb">                            | cut -f 1 -d &#39; &#39;</span>
</span><span class='line'><span class="sb">                            `</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 改行で要素を分割</span>
</span><span class='line'><span class="n">instance_ids</span> <span class="o">=</span> <span class="n">instance_ids</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">checked_instance_ids</span> <span class="o">=</span> <span class="n">checked_instance_ids</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># インスタンス一覧にあってCloudWatch側にない監視追加対象のインスタンスID一覧を抽出</span>
</span><span class='line'><span class="n">new_instance_ids</span> <span class="o">=</span> <span class="n">instance_ids</span> <span class="o">-</span> <span class="n">checked_instance_ids</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># CloudWatch側にあってインスタンス一覧にない削除対象のインスタンスID一覧を抽出</span>
</span><span class='line'><span class="n">deleted_instance_ids</span> <span class="o">=</span> <span class="n">checked_instance_ids</span> <span class="o">-</span> <span class="n">instance_ids</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 監視追加対象のインスタンスID一覧が空でなければCloudWatchに追加していく</span>
</span><span class='line'><span class="k">unless</span> <span class="n">new_instance_ids</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>  <span class="n">new_instance_ids</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">instance_id</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># StageというKeyのタグで本番かそれ以外を分けている</span>
</span><span class='line'>    <span class="n">stage</span> <span class="o">=</span> <span class="sb">`aws --region </span><span class="si">#{</span><span class="n">region</span><span class="si">}</span><span class="sb"> ec2 describe-instances \</span>
</span><span class='line'><span class="sb">                 --instance-ids </span><span class="si">#{</span><span class="n">instance_id</span><span class="si">}</span><span class="sb"> \</span>
</span><span class='line'><span class="sb">                 --query &#39;Reservations[].Instances[].Tags[?Key==\`</span><span class="no">Stage</span><span class="p">\</span><span class="sb">`].Value&#39; \</span>
</span><span class='line'><span class="sb">                 --output text</span>
</span><span class='line'><span class="sb">                 `</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># 本番の場合は通知先が違うのでSNSの向き先を変える</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="s1">&#39;production&#39;</span>
</span><span class='line'>      <span class="n">sns_topic</span> <span class="o">=</span> <span class="s1">&#39;PRODUCTION_SNS_TOPIC&#39;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">sns_topic</span> <span class="o">=</span> <span class="s1">&#39;OTHER_SNS_TOPIC&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># MAIN: ここで設定を追加する</span>
</span><span class='line'>    <span class="sb">`aws --region </span><span class="si">#{</span><span class="n">region</span><span class="si">}</span><span class="sb"> cloudwatch put-metric-alarm \</span>
</span><span class='line'><span class="sb">         --alarm-name &quot;</span><span class="si">#{</span><span class="n">instance_id</span><span class="si">}</span><span class="sb"> StatusCheckFailed_Check&quot; \</span>
</span><span class='line'><span class="sb">         --metric-name StatusCheckFailed \</span>
</span><span class='line'><span class="sb">         --namespace AWS/EC2 \</span>
</span><span class='line'><span class="sb">         --statistic Maximum \</span>
</span><span class='line'><span class="sb">         --dimensions Name=InstanceId,Value=</span><span class="si">#{</span><span class="n">instance_id</span><span class="si">}</span><span class="sb"> \</span>
</span><span class='line'><span class="sb">         --period 60 \</span>
</span><span class='line'><span class="sb">         --unit Count \</span>
</span><span class='line'><span class="sb">         --evaluation-periods 1 \</span>
</span><span class='line'><span class="sb">         --threshold 0 \</span>
</span><span class='line'><span class="sb">         --comparison-operator GreaterThanThreshold \</span>
</span><span class='line'><span class="sb">         --ok-actions </span><span class="si">#{</span><span class="n">sns_topic</span><span class="si">}</span><span class="sb"> \</span>
</span><span class='line'><span class="sb">         --alarm-actions </span><span class="si">#{</span><span class="n">sns_topic</span><span class="si">}</span><span class="sb"> \</span>
</span><span class='line'><span class="sb">         --insufficient-data-actions </span><span class="si">#{</span><span class="n">sns_topic</span><span class="si">}</span><span class="sb"></span>
</span><span class='line'><span class="sb">         `</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2"> StatusCheckFailed_Check is created&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 削除対象のインスタンスID一覧が空でなければ設定を削除していく</span>
</span><span class='line'><span class="k">unless</span> <span class="n">deleted_instance_ids</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>  <span class="n">deleted_instance_ids</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">instance_id</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># MAIN: ここで設定を削除する</span>
</span><span class='line'>    <span class="sb">`aws --region </span><span class="si">#{</span><span class="n">region</span><span class="si">}</span><span class="sb"> cloudwatch delete-alarms \</span>
</span><span class='line'><span class="sb">         --alarm-names &quot;</span><span class="si">#{</span><span class="n">instance_id</span><span class="si">}</span><span class="sb"> StatusCheckFailed_Check&quot;`</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">instance_id</span><span class="si">}</span><span class="s2"> StatusCheckFailed_Check is deleted&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>こんな感じでやってる。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[特定のインスタンスIDのタグのValueを出力する]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2016/07/12/ec2-tag-describe-instances/"/>
    <updated>2016-07-12T10:31:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2016/07/12/ec2-tag-describe-instances</id>
    <content type="html"><![CDATA[<h3><code>query</code>オプションとかよー使わんわということで個人的メモ</h3>

<p><code>Name</code>タグを出力したければこう</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ aws ec2 describe-instances \
</span><span class='line'>          --instance-ids i-XXXXXXXX \
</span><span class='line'>          --query 'Reservations[].Instances[].Tags[?Key==`Name`].Value' \
</span><span class='line'>          --output text</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[特定のRoleのEIPが付与されているEC2がTerminateされた時に新しく起動したEC2に浮いたEIPを付与させるスクリプト]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2016/07/08/samsara-eip/"/>
    <updated>2016-07-08T13:32:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2016/07/08/samsara-eip</id>
    <content type="html"><![CDATA[<p>件の通り</p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="ja" dir="ltr"><a href="https://twitter.com/kenjiskywalker">@kenjiskywalker</a> そんな仕組みあるの？</p>&mdash; そのっつ (Naotoshi Seo) (@sonots) <a href="https://twitter.com/sonots/status/751219867785711616">July 8, 2016</a></blockquote>


<p> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="ja" dir="ltr"><a href="https://twitter.com/kenjiskywalker">@kenjiskywalker</a> クレクレ</p>&mdash; そのっつ (Naotoshi Seo) (@sonots) <a href="https://twitter.com/sonots/status/751220071335235585">July 8, 2016</a></blockquote>


<p> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>今見直したら結構ひどい感じだったけど一旦公開しておく。<br/>
AWS SDK for Rubyを利用してもいいし、これぐらいならgoで書いても良いスね。</p>

<h3>仕組み</h3>

<ul>
<li><code>Role</code>  - web, db, app, etc&hellip;</li>
<li><code>Stage</code> - development, staging, production, etc&hellip;</li>
</ul>


<p><code>EC2</code>のインスタンスそれぞれに<a href="http://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/Using_Tags.html">タグ</a>の設定を入れている。<br/>
それぞれのインスタンスは<a href="http://docs.aws.amazon.com/ja_jp/AutoScaling/latest/DeveloperGuide/WhatIsAutoScaling.html">AutoScalingGroup</a>管理下にあり、<br/>
上記タグもそれぞれのAutoScalingGroupにてインスタンス起動時に付与するようになっている。</p>

<h4>起動時に浮いたEIPをアサインさせたい</h4>

<p>Ref: <a href="http://qiita.com/toshihirock/items/81d6612511f0d1f5db77">Qiita:AmazonLinuxのcloud-initについての調査メモ</a></p>

<p><code>cloud-init</code>のいい感じのオフィシャルドキュメントってどこにあるんだ&hellip;</p>

<ul>
<li>/var/lib/cloud/scripts/per-boot/004_assign-elastic-ip.rb</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># 基本的に 各Role に EIP を付与するインスタンスは 2台 毎</span>
</span><span class='line'><span class="c1"># </span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'>
</span><span class='line'><span class="no">INSTANCEID</span>  <span class="o">=</span> <span class="sb">`curl -s http://169.254.169.254/latest/meta-data/instance-id/`</span>
</span><span class='line'>
</span><span class='line'><span class="no">REGION</span>      <span class="o">=</span> <span class="s1">&#39;ap-northeast-1&#39;</span>
</span><span class='line'><span class="no">ROLE</span>        <span class="o">=</span> <span class="sb">`aws --region </span><span class="si">#{</span><span class="no">REGION</span><span class="si">}</span><span class="sb"> ec2 describe-instances \</span>
</span><span class='line'><span class="sb">                 --instance-ids </span><span class="si">#{</span><span class="no">INSTANCEID</span><span class="si">}</span><span class="sb"> \</span>
</span><span class='line'><span class="sb">                 --output text \</span>
</span><span class='line'><span class="sb">                 --query &#39;Reservations[].Instances[].Tags[?Key==\`</span><span class="no">Role</span><span class="p">\</span><span class="sb">`].[Value]&#39; \</span>
</span><span class='line'><span class="sb">                 `</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'><span class="no">STAGE</span>       <span class="o">=</span> <span class="sb">`aws --region </span><span class="si">#{</span><span class="no">REGION</span><span class="si">}</span><span class="sb"> ec2 describe-instances \</span>
</span><span class='line'><span class="sb">                 --instance-ids </span><span class="si">#{</span><span class="no">INSTANCEID</span><span class="si">}</span><span class="sb"> \</span>
</span><span class='line'><span class="sb">                 --output text \</span>
</span><span class='line'><span class="sb">                 --query &#39;Reservations[].Instances[].Tags[?Key==\`</span><span class="no">Stage</span><span class="p">\</span><span class="sb">`].[Value]&#39; \</span>
</span><span class='line'><span class="sb">                 `</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># foo, bar以外はEIPの付与はないので一旦この条件を設定する</span>
</span><span class='line'><span class="nb">exit</span> <span class="mi">0</span> <span class="k">unless</span> <span class="no">ROLE</span> <span class="o">==</span> <span class="s1">&#39;foo&#39;</span> <span class="o">||</span> <span class="no">ROLE</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 浮いたEIPを入れる変数</span>
</span><span class='line'><span class="n">elasticip_allocation_ids</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># ROLE と STAGE 毎に保持している EIP は違う</span>
</span><span class='line'><span class="c1"># TODO: hash or json</span>
</span><span class='line'><span class="k">case</span> <span class="no">ROLE</span>
</span><span class='line'><span class="k">when</span> <span class="s1">&#39;foo&#39;</span>
</span><span class='line'>  <span class="k">if</span> <span class="no">STAGE</span> <span class="o">==</span> <span class="s1">&#39;development&#39;</span>
</span><span class='line'>    <span class="n">elasticip_allocation_ids</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;eipalloc-XXXXXXXX&#39;</span><span class="p">,</span> <span class="s1">&#39;eipalloc-XXXXXXXX&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">elsif</span> <span class="no">STAGE</span> <span class="o">==</span> <span class="s1">&#39;staging&#39;</span>
</span><span class='line'>    <span class="n">elasticip_allocation_ids</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;eipalloc-XXXXXXXX&#39;</span><span class="p">,</span> <span class="s1">&#39;eipalloc-XXXXXXXX&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="nb">exit</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">when</span> <span class="s1">&#39;bar&#39;</span>
</span><span class='line'>  <span class="k">if</span> <span class="no">STAGE</span> <span class="o">==</span> <span class="s1">&#39;production&#39;</span>
</span><span class='line'>    <span class="n">elasticip_allocation_ids</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;eipalloc-XXXXXXXX&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">elsif</span> <span class="no">STAGE</span> <span class="o">==</span> <span class="s1">&#39;staging&#39;</span>
</span><span class='line'>    <span class="n">elasticip_allocation_ids</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;eipalloc-XXXXXXXX&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="nb">exit</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">when</span> <span class="s1">&#39;baz&#39;</span>
</span><span class='line'>  <span class="k">if</span> <span class="no">STAGE</span> <span class="o">==</span> <span class="s1">&#39;production&#39;</span>
</span><span class='line'>    <span class="n">elasticip_allocation_ids</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;eipalloc-XXXXXXXX&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">elsif</span> <span class="no">STAGE</span> <span class="o">==</span> <span class="s1">&#39;staging&#39;</span>
</span><span class='line'>    <span class="n">elasticip_allocation_ids</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;eipalloc-XXXXXXXX&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="nb">exit</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">0</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">elasticip_allocation_ids</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">eip_id</span><span class="o">|</span>
</span><span class='line'>  <span class="c1"># 対象のEIPにEC2が紐付いているか確認(浮いたEIPを探す)</span>
</span><span class='line'>  <span class="n">assigned_instance_id</span> <span class="o">=</span> <span class="sb">`aws --region </span><span class="si">#{</span><span class="no">REGION</span><span class="si">}</span><span class="sb"> ec2 describe-addresses \</span>
</span><span class='line'><span class="sb">                            --allocation-ids </span><span class="si">#{</span><span class="n">eip_id</span><span class="si">}</span><span class="sb"> \</span>
</span><span class='line'><span class="sb">                            | jq &#39;.Addresses[].InstanceId&#39; \</span>
</span><span class='line'><span class="sb">                            `</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># 浮いたEIPがあれば付与する処理へ移る</span>
</span><span class='line'>  <span class="k">next</span> <span class="k">unless</span> <span class="n">assigned_instance_id</span> <span class="o">==</span> <span class="s1">&#39;null&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># EIPを付与する</span>
</span><span class='line'>  <span class="sb">`aws --region </span><span class="si">#{</span><span class="no">REGION</span><span class="si">}</span><span class="sb"> ec2 associate-address \</span>
</span><span class='line'><span class="sb">     --allocation-id </span><span class="si">#{</span><span class="n">eip_id</span><span class="si">}</span><span class="sb"> \</span>
</span><span class='line'><span class="sb">     --instance-id </span><span class="si">#{</span><span class="no">INSTANCEID</span><span class="si">}</span><span class="sb">`</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;COMPLETE: associate-address --allocation-id </span><span class="si">#{</span><span class="n">eip_id</span><span class="si">}</span><span class="s2"> --instance-id </span><span class="si">#{</span><span class="no">INSTANCEID</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">0</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;CANNOT ASSOCIATE EIP to `hostname`&quot;</span>
</span><span class='line'><span class="nb">exit</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>という感じで<code>/var/lib/cloud/scripts/per-boot/</code>配下にスクリプトを置いている。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[問題があったのでfluentdでsigdumpを使いstactraceしてmackerel-client-rubyにPRした話]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2016/07/08/mackerel-meets-fluentd-and-debug-it/"/>
    <updated>2016-07-08T12:45:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2016/07/08/mackerel-meets-fluentd-and-debug-it</id>
    <content type="html"><![CDATA[<p>みんなのネットワーク環境が安定しているのか..<br/>
我々の世界線にノイズが混在してしまっているのか&hellip;</p>

<p>それを調べるすべはないが、下記のような問題があった。</p>

<ul>
<li><code>mackerel</code>で突然グラフが表示されなくなる</li>
<li>そのグラフを表示しているのは<code>fluent-plugin-mackerel</code>を利用して<code>fluentd</code>経由で作成している</li>
<li>その<code>td-agent</code>は再起動しようとすると<code>Timeout error</code>になる</li>
</ul>


<p>ということで怪奇現象を解決する為にやったことをメモ</p>

<h3>愚直に<code>td-agent</code>の再起動を試みてみる</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[watashi@example-host ~]$ 
</span><span class='line'>[watashi@example-host ~]$ 
</span><span class='line'>[watashi@example-host ~]$ sudo service td-agent restart
</span><span class='line'>Restarting td-agent:
</span><span class='line'>
</span><span class='line'>Timeout error occurred trying to stop td-agent...                                          [  OK  ]
</span><span class='line'>[watashi@example-host ~]$ </span></code></pre></td></tr></table></div></figure>


<p>ダメや</p>

<p>fluentdのコミッターの<a href="https://twitter.com/sonots">@sonots</a>さんに</p>

<ul>
<li>ログは出ない</li>
<li>デーモンは生きている</li>
</ul>


<p>そんな現象に出会ったことない？と聞いたところ <br/>
fluentdには<a href="https://github.com/frsyuki/sigdump">sigdump</a>が入っているから<br/>
そこでstacktraceを追ってみれば、と意識の高いお返事を頂いたので実行してみる。</p>

<h4>kill -CONT</h4>

<p><a href="https://github.com/frsyuki/sigdump#usage">ドキュメント</a>に書いてあるように<code>CONT</code>のシグナルを送る</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[watashi@example-host ~]$ ps auxwwwf | grep td-agent
</span><span class='line'>td-agent  7779  0.0  0.3 241756 26700 ?        Sl   May27   0:00 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid
</span><span class='line'>td-agent  7915  0.3  3.7 838976 288956 ?       Sl   May27 225:44  \_ /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid
</span><span class='line'>[watashi@example-host ~]$ 
</span><span class='line'>[watashi@example-host ~]$ sudo kill -CONT 7915
</span><span class='line'>[watashi@example-host ~]$ 
</span><span class='line'>[watashi@example-host ~]$ ps auxwwwf | grep td-agent
</span><span class='line'>td-agent  7779  0.0  0.3 241756 26836 ?        Sl   May27   0:00 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid
</span><span class='line'>td-agent  7915  0.3  3.7 838976 288956 ?       Sl   May27 225:44  \_ /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid
</span><span class='line'>[watashi@example-host ~]$</span></code></pre></td></tr></table></div></figure>


<h4>sigdumpができあがっている</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[watashi@example-host ~]$ ls -la /tmp/
</span><span class='line'>total 1048
</span><span class='line'>-rw-rw-rw-  1 td-agent td-agent    5937 Jul  7 10:51 sigdump-7915.log
</span><span class='line'>[watashi@example-host ~]$</span></code></pre></td></tr></table></div></figure>


<h4>sigdumpの中身を見てみる</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[watashi@example-host ~]$ sudo view /tmp/sigdump-7915.log
</span><span class='line'>Sigdump at 2016-07-07 10:52:00 +0900 process 7915 (/usr/sbin/td-agent)
</span><span class='line'>  Thread #&lt;Thread:0x007fce4f19e658&gt; status=run priority=0
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:39:in `backtrace'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:39:in `dump_backtrace'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:25:in `block in dump_all_thread_backtrace'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:24:in `each'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:24:in `dump_all_thread_backtrace'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:16:in `block in dump'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:119:in `open'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:119:in `_open_dump_path'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:14:in `dump'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/sigdump-0.2.3/lib/sigdump.rb:7:in `block in setup'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/agent.rb:102:in `call'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/agent.rb:102:in `join'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/agent.rb:102:in `block in shutdown'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/agent.rb:102:in `each'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/agent.rb:102:in `shutdown'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/root_agent.rb:131:in `block in shutdown'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/root_agent.rb:130:in `each'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/root_agent.rb:130:in `shutdown'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/engine.rb:229:in `shutdown'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/engine.rb:200:in `run'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/supervisor.rb:597:in `run_engine'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/supervisor.rb:148:in `block in start'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/supervisor.rb:352:in `call'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/supervisor.rb:352:in `main_process'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/supervisor.rb:325:in `block in supervise'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/supervisor.rb:324:in `fork'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/supervisor.rb:324:in `supervise'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/supervisor.rb:142:in `start'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/command/fluentd.rb:171:in `&lt;top (required)&gt;'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/site_ruby/2.1.0/rubygems/core_ext/kernel_require.rb:54:in `require'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/site_ruby/2.1.0/rubygems/core_ext/kernel_require.rb:54:in `require'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/bin/fluentd:6:in `&lt;top (required)&gt;'
</span><span class='line'>      /opt/td-agent/embedded/bin/fluentd:23:in `load'
</span><span class='line'>      /opt/td-agent/embedded/bin/fluentd:23:in `&lt;top (required)&gt;'
</span><span class='line'>      /usr/sbin/td-agent:7:in `load'
</span><span class='line'>      /usr/sbin/td-agent:7:in `&lt;main&gt;'
</span><span class='line'>  Thread #&lt;Thread:0x007fce4f1910c0&gt; status=sleep priority=0
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/output.rb:165:in `sleep'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/output.rb:165:in `wait'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/output.rb:165:in `cond_wait'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/output.rb:149:in `run'
</span><span class='line'>  Thread #&lt;Thread:0x007fce4f192880&gt; status=sleep priority=0
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/cool.io-1.4.2/lib/cool.io/loop.rb:88:in `run_once'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/cool.io-1.4.2/lib/cool.io/loop.rb:88:in `run'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/plugin/out_forward.rb:185:in `run'
</span><span class='line'>  Thread #&lt;Thread:0x007fce4f18eb40&gt; status=sleep priority=0
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:923:in `connect'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:923:in `block in connect'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/2.1.0/timeout.rb:75:in `timeout'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:923:in `connect'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:863:in `do_start'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:852:in `start'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:1375:in `request'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/adapter/net_http.rb:82:in `perform_request'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/adapter/net_http.rb:40:in `block in call'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/adapter/net_http.rb:87:in `with_net_http_connection'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/adapter/net_http.rb:32:in `call'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/rack_builder.rb:139:in `build_response'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/connection.rb:377:in `run_request'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/connection.rb:177:in `post'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/mackerel-client-0.1.0/lib/mackerel/client.rb:108:in `post_service_metrics'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluent-plugin-mackerel-0.1.3/lib/fluent/plugin/out_mackerel.rb:161:in `send'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluent-plugin-mackerel-0.1.3/lib/fluent/plugin/out_mackerel.rb:151:in `write'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/buffer.rb:345:in `write_chunk'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/buffer.rb:324:in `pop'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/output.rb:329:in `try_flush'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/output.rb:140:in `run'
</span><span class='line'>  
</span><span class='line'>  ...
</span><span class='line'>  
</span><span class='line'>    GC stat:
</span><span class='line'>      count: 59808
</span><span class='line'>      heap_used: 261
</span><span class='line'>      heap_length: 261
</span><span class='line'>      heap_increment: 0
</span><span class='line'>      heap_live_slot: 105333
</span><span class='line'>      heap_free_slot: 1061
</span><span class='line'>      heap_final_slot: 0
</span><span class='line'>      heap_swept_slot: 26253
</span><span class='line'>      heap_eden_page_length: 261
</span><span class='line'>      heap_tomb_page_length: 0
</span><span class='line'>      total_allocated_object: 2536413815
</span><span class='line'>      total_freed_object: 2536308482
</span><span class='line'>      malloc_increase: 3756384
</span><span class='line'>      malloc_limit: 16777216
</span><span class='line'>      minor_gc_count: 58261
</span><span class='line'>      major_gc_count: 1547
</span><span class='line'>      remembered_shady_object: 2178
</span><span class='line'>      remembered_shady_object_limit: 2276
</span><span class='line'>      old_object: 62144
</span><span class='line'>      old_object_limit: 112630
</span><span class='line'>      oldmalloc_increase: 3800672
</span><span class='line'>      oldmalloc_limit: 16777216
</span><span class='line'>  Built-in objects:
</span><span class='line'>   106,394: TOTAL
</span><span class='line'>    47,172: T_STRING
</span><span class='line'>    21,189: T_DATA
</span><span class='line'>    16,574: T_ARRAY
</span><span class='line'>     6,805: T_NODE
</span><span class='line'>     3,221: T_OBJECT
</span><span class='line'>     3,064: T_CLASS
</span><span class='line'>     2,418: T_HASH
</span><span class='line'>     1,910: T_FILE
</span><span class='line'>     1,300: FREE
</span><span class='line'>       736: T_ICLASS
</span><span class='line'>       719: T_REGEXP
</span><span class='line'>       701: T_STRUCT
</span><span class='line'>       287: T_MATCH
</span><span class='line'>       168: T_MODULE
</span><span class='line'>        61: T_BIGNUM
</span><span class='line'>        59: T_RATIONAL
</span><span class='line'>         9: T_FLOAT
</span><span class='line'>         1: T_COMPLEX
</span><span class='line'>[watashi@example-host ~]$</span></code></pre></td></tr></table></div></figure>


<h4>よくわからんが読んで見る</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  Thread #&lt;Thread:0x007fce4f18f1a8&gt; status=sleep priority=0
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:923:in `connect'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:923:in `block in connect'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/2.1.0/timeout.rb:75:in `timeout'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:923:in `connect'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:863:in `do_start'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:852:in `start'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/2.1.0/net/http.rb:1375:in `request'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/adapter/net_http.rb:82:in `perform_request'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/adapter/net_http.rb:40:in `block in call'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/adapter/net_http.rb:87:in `with_net_http_connection'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/adapter/net_http.rb:32:in `call'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/rack_builder.rb:139:in `build_response'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/connection.rb:377:in `run_request'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/faraday-0.9.2/lib/faraday/connection.rb:177:in `post'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/mackerel-client-0.1.0/lib/mackerel/client.rb:108:in `post_service_metrics'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluent-plugin-mackerel-0.1.3/lib/fluent/plugin/out_mackerel.rb:161:in `send'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluent-plugin-mackerel-0.1.3/lib/fluent/plugin/out_mackerel.rb:151:in `write'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/buffer.rb:345:in `write_chunk'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/buffer.rb:324:in `pop'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/output.rb:329:in `try_flush'
</span><span class='line'>      /opt/td-agent/embedded/lib/ruby/gems/2.1.0/gems/fluentd-0.12.20/lib/fluent/output.rb:140:in `run'</span></code></pre></td></tr></table></div></figure>


<p><code>fluent-plugin-mackerel</code>と<code>faraday</code>という文字列が見える</p>

<h3>mackerel-client-rubyにPRを送る</h3>

<p><a href="https://github.com/mackerelio/mackerel-client-ruby/pull/24">pull/24</a>のやりとりがそれ</p>

<p><code>faraday</code>に<code>timeout</code>のオプションがなかったので足した。</p>

<h2>後処理</h2>

<ul>
<li>対象サーバで<code>mackerel-client-ruby</code>をバージョンアップ</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[watashi@example-host ~]$
</span><span class='line'>[watashi@example-host ~]$ sudo /opt/td-agent/embedded/bin/gem update mackerel-client
</span><span class='line'>Updating installed gems
</span><span class='line'>Updating mackerel-client
</span><span class='line'>Fetching: mackerel-client-0.1.1.gem (100%)
</span><span class='line'>Successfully installed mackerel-client-0.1.1
</span><span class='line'>Parsing documentation for mackerel-client-0.1.1
</span><span class='line'>Installing ri documentation for mackerel-client-0.1.1
</span><span class='line'>Installing darkfish documentation for mackerel-client-0.1.1
</span><span class='line'>Done installing documentation for mackerel-client after 0 seconds
</span><span class='line'>Parsing documentation for mackerel-client-0.1.1
</span><span class='line'>Done installing documentation for mackerel-client after 0 seconds
</span><span class='line'>Gems updated: mackerel-client
</span><span class='line'>[watashi@example-host ~]$</span></code></pre></td></tr></table></div></figure>


<ul>
<li>対象のプロセスを始末してデーモンを起動</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[watashi@example-host ~]$ kill 7915
</span><span class='line'>[watashi@example-host ~]$ ps auxwwwf | grep td-agent
</span><span class='line'>td-agent  7779  0.0  0.3 241756 26836 ?        Sl   May27   0:00 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid
</span><span class='line'>td-agent  7915  0.3  3.7 838976 288956 ?       Sl   May27 225:44  \_ /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid
</span><span class='line'>[watashi@example-host ~]$
</span><span class='line'>[watashi@example-host ~]$ kill 7779
</span><span class='line'>[watashi@example-host ~]$ ps auxwwwf | grep td-agent
</span><span class='line'>td-agent  7779  0.0  0.3 241756 26836 ?        Sl   May27   0:00 /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid
</span><span class='line'>td-agent  7915  0.3  3.7 838976 288956 ?       Sl   May27 225:44  \_ /opt/td-agent/embedded/bin/ruby /usr/sbin/td-agent --log /var/log/td-agent/td-agent.log --use-v1-config --group td-agent --daemon /var/run/td-agent/td-agent.pid
</span><span class='line'>[watashi@example-host ~]$
</span><span class='line'>[watashi@example-host ~]$ kill -9 7915
</span><span class='line'>[watashi@example-host ~]$ kill -9 7779
</span><span class='line'>[watashi@example-host ~]$ ps auxwwwf | grep td-agent
</span><span class='line'>[watashi@example-host ~]$
</span><span class='line'>[watashi@example-host ~]$
</span><span class='line'>[watashi@example-host ~]$ sudo  service td-agent start
</span><span class='line'>Starting td-agent:                                         [  OK  ]
</span><span class='line'>[watashi@example-host ~]$</span></code></pre></td></tr></table></div></figure>


<p>ログや<code>mackerel</code>などで問題なく出力がされているか確認する。</p>

<p>サービスを利用させてもらっている側もこのように地味なところで貢献できるので<br/>
何かあったら色々とやってみよう💪</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Terraformを始める上でのresourceの命名規則について]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2016/07/06/terraform-newbie/"/>
    <updated>2016-07-06T09:52:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2016/07/06/terraform-newbie</id>
    <content type="html"><![CDATA[<h2>Terraformとは</h2>

<p><a href="https://www.terraform.io">https://www.terraform.io</a>ここ見てください。<br/>
<code>INFRASTRUCTURE AS CODE</code>と書いてあります。</p>

<h2>何が便利か</h2>

<p>たとえばAWSの新規VPCの作成など画面ポチポチで設定していくオペレーションをコードに落とせる。</p>

<blockquote><p>それってAPI叩けば同じでは？<br/>
PaaSが<a href="https://www.terraform.io/docs/providers/index.html">色々</a>対応している。MySQLにも対応しているの&hellip;</p></blockquote>

<h2>伝えたいこと</h2>

<p>たとえばVPCを構築するとして</p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="ja" dir="ltr">Terraformの有識者にどうにかしてresourceの名前にvariableの値を入れる方法を教えてほしい🤔</p>&mdash; kenjiskywalker (@kenjiskywalker) <a href="https://twitter.com/kenjiskywalker/status/750200917312417792">July 5, 2016</a></blockquote>


<p> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resource "aws_vpc" "${var.prefix}-${var.environment_name}-vpc" {
</span><span class='line'>    cidr_block           = "${var.vpc.cidr_block}"
</span><span class='line'>    enable_dns_hostnames = true
</span><span class='line'>    enable_dns_support   = true
</span><span class='line'>    instance_tenancy     = "default"
</span><span class='line'>
</span><span class='line'>    tags {
</span><span class='line'>        "Name" = "${var.environment_name}-vpc"
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>などと<code>resource</code>名をユニークな感じでやろうとしたのだけれど</p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="ja" dir="ltr">so this is by design.と言われればそれまでだ <a href="https://t.co/Im2kwIqiQa">https://t.co/Im2kwIqiQa</a></p>&mdash; kenjiskywalker (@kenjiskywalker) <a href="https://twitter.com/kenjiskywalker/status/750218349884301313">July 5, 2016</a></blockquote>


<p> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p><code>by design</code>と言われていたので、なんだか使いづらいな〜と考えていた。が</p>

<blockquote class="twitter-tweet" data-lang="en"><p lang="ja" dir="ltr">そもそもresourceは固有な名前を設定すべきではないという思想が理解できていなかった、例えばpublicであればfoo-development-publicなどとうい名前を付けるべきではなかった</p>&mdash; kenjiskywalker (@kenjiskywalker) <a href="https://twitter.com/kenjiskywalker/status/750243305481396224">July 5, 2016</a></blockquote>


<p> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>そうなのだ。そもそもこの発想で良く、<code>resource</code>はあくまでTerraform内での管理するためだけの命名であるので</p>

<ul>
<li>vpc.tf</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resource "aws_vpc" "main-vpc" {
</span><span class='line'>    cidr_block           = "${var.vpc.cidr_block}"
</span><span class='line'>    enable_dns_hostnames = true
</span><span class='line'>    enable_dns_support   = true
</span><span class='line'>    instance_tenancy     = "default"
</span><span class='line'>
</span><span class='line'>    tags {
</span><span class='line'>        "Name" = "${var.environment_name}-vpc"
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>このように<code>Name Tags</code>でユニークな情報を付与すれば良かった。  <br/>
このことに気付かず<code>resource</code>にひたすら<code>variable</code>の値を入れようと頑張っていた。</p>

<p>結局、上記のように<code>resource</code>にユニークな情報を入れない仕組みで汎用性は担保できた。<br/>
これで似たような環境も</p>

<ul>
<li>vpc.tf</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Create Subnet
</span><span class='line'># - ec2:CreateSubnet
</span><span class='line'>resource "aws_subnet" "some-subnet-a" {
</span><span class='line'>    vpc_id            = "${aws_vpc.main-vpc.id}"
</span><span class='line'>    cidr_block        = "${var.vpc.public_subnet_a}"
</span><span class='line'>    availability_zone = "${var.availability_zone.a}"
</span><span class='line'>    tags {
</span><span class='line'>        Name = "${var.environment_name}-some-subnet-a"
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ul>
<li>variables.tf</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>variable "region" {
</span><span class='line'>    default = "ap-northeast-1"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>variable "environment_name" {
</span><span class='line'>    default = "development"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>variable "availability_zone" {
</span><span class='line'>    default = {
</span><span class='line'>        a = "ap-northeast-1a"
</span><span class='line'>        c = "ap-northeast-1c"
</span><span class='line'>    }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>variable "vpc" {
</span><span class='line'>    default = {
</span><span class='line'>        cidr_block    = "10.200.0.0/16"
</span><span class='line'>        some_subnet_a = "10.200.210.0/24"
</span><span class='line'>        some_subnet_c = "10.200.211.0/24"
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>上記のように<code>variables.tf</code>などと値を別のファイルに分けておくことで<br/>
汎用的なテンプレートが作成可能となる。しかし便利だな〜</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CodeDeployのfailをSlackに通知して原因までたどりやすくする]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2016/03/14/infrom-codedeploy-error-to-slack/"/>
    <updated>2016-03-14T11:03:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2016/03/14/infrom-codedeploy-error-to-slack</id>
    <content type="html"><![CDATA[<p><a href="https://aws.amazon.com/jp/about-aws/whats-new/2016/02/aws-codedeploy-adds-push-notification-support/">AWS CodeDeploy Adds Push Notification Support</a></p>

<p>ということで、これができるまではひたすらstate毎にslackに通知していたけど<br/>
failしたらfailしたよって通知するようにした。</p>

<p>流れ的にはこう</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CodeDeploy fail -&gt; AWS SNS -&gt; AWS Lambda -&gt; Slack</span></code></pre></td></tr></table></div></figure>


<h2>やり方</h2>

<h3>AWS SNSで受け口をつくる</h3>

<p>CodeDeployがfailした歳に利用するSNSを用意する</p>

<ul>
<li>NotifyCodeDeployErrorToSlack</li>
</ul>


<p>みたいな感じで。開発環境やステージングなどでslackの通知グループが別れる場合は<br/>
都度SNSをつくっているんだけど、これもっと良いやり方ないのかな？</p>

<h3>CodeDeployのtriggerに先ほどつくったSNSを設定する</h3>

<p><img src="https://dl.dropboxusercontent.com/u/5390179/capture-CodeDeployTrigger.png" alt="https://dl.dropboxusercontent.com/u/5390179/capture-CodeDeployTrigger.png" /></p>

<p>fail以外にもステータスがあるのでそこでhookかけても良いですね。<br/>
自分のところはstate毎に通知させているので一旦この形です。</p>

<h3>AWS LambdaでSlackへの通知を行う</h3>

<ul>
<li>NotifyCodeDeployErrorToSlackFunction</li>
</ul>


<p>とか適当な名前でfunctionをつくる</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// Ref: https://gist.github.com/vgeshel/1dba698aed9e8b39a464</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Loading function&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="nx">https</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;https&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">);</span>
</span><span class='line'><span class="c1">// to get the slack hook url, go into slack admin and create a new &quot;Incoming Webhook&quot; integration</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">slack_url</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">region</span> <span class="o">=</span> <span class="s1">&#39;ap-northeast-1&#39;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">codedeploy_url</span> <span class="o">=</span> <span class="s1">&#39;https://&#39;</span> <span class="o">+</span> <span class="nx">region</span> <span class="o">+</span> <span class="s1">&#39;.console.aws.amazon.com/codedeploy/home?region=&#39;</span> <span class="o">+</span> <span class="nx">region</span> <span class="o">+</span> <span class="s1">&#39;#/deployments/&#39;</span>
</span><span class='line'><span class="kr">const</span> <span class="nx">slack_req_opts</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">slack_url</span><span class="p">);</span>
</span><span class='line'><span class="nx">slack_req_opts</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="s1">&#39;POST&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nx">slack_req_opts</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Records</span> <span class="o">||</span> <span class="p">[]).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">rec</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">rec</span><span class="p">.</span><span class="nx">Sns</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="nx">https</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">slack_req_opts</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">context</span><span class="p">.</span><span class="nx">succeed</span><span class="p">(</span><span class="s1">&#39;posted to slack&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">context</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="s1">&#39;status code: &#39;</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;problem with request: &#39;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">context</span><span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">rec</span><span class="p">.</span><span class="nx">Sns</span><span class="p">.</span><span class="nx">Message</span><span class="p">);</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="s1">&#39;Application: &#39;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">applicationName</span> <span class="o">+</span> <span class="s1">&#39; deploymentGroupName: &#39;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">deploymentGroupName</span> <span class="o">+</span> <span class="s1">&#39; deploymentId: &#39;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">deploymentId</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">codedeploy_url</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">deploymentId</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">req</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span><span class="nx">text</span><span class="o">:</span> <span class="nx">str</span><span class="p">}));</span> <span class="c1">// for testing: , channel: &#39;@vadim&#39;</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">req</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>slack_url</code>に自前のIncoming Webhookを入れる</p>

<h2>通知される</h2>

<p><img src="https://dl.dropboxusercontent.com/u/5390179/capture-CodeDeployError.png" alt="" /></p>

<p>ご覧のとおりFail時に通知され、かつURLをクリックしたらCodeDeployのエラー画面にとべて便利なので<br/>
ご利用ください。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SlackのAPIでchannel.listやchannel.infoで取れない時はgroup.listやgroup.infoで取ろう]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2016/02/25/slack-api-channel-to-group/"/>
    <updated>2016-02-25T14:18:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2016/02/25/slack-api-channel-to-group</id>
    <content type="html"><![CDATA[<p>以上です。(どこかドキュメント落ちてるかな)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CodeDeployでApplicationStopでどうしようもなくなったら]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2016/01/21/codedeploy-applicationstop-failed/"/>
    <updated>2016-01-21T17:37:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2016/01/21/codedeploy-applicationstop-failed</id>
    <content type="html"><![CDATA[<p>これやで</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rm -rf  /opt/codedeploy-agent/deployment-root/deployment-instructions/*</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[awscliでput-metric-alarmでELBのUnHealthyHostCountUpをモニタリングして増えたりしたらアラートとばすくん]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2016/01/19/awscli-put-metric-alarm-to-elb/"/>
    <updated>2016-01-19T11:24:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2016/01/19/awscli-put-metric-alarm-to-elb</id>
    <content type="html"><![CDATA[<h2>自分用メモ</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="n">loadbalancers</span> <span class="o">=</span> <span class="sb">`aws elb describe-load-balancers | jq &#39;.[][][&quot;LoadBalancerName&quot;]&#39; -r `</span>
</span><span class='line'><span class="n">alert_sns</span> <span class="o">=</span> <span class="s2">&quot;SNS&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">loadbalancers</span><span class="o">.</span><span class="n">each_line</span> <span class="k">do</span> <span class="o">|</span><span class="n">lb</span><span class="o">|</span>
</span><span class='line'>  <span class="n">lb</span><span class="o">.</span><span class="n">chomp!</span>
</span><span class='line'>  <span class="nb">p</span> <span class="n">lb</span>
</span><span class='line'><span class="sb">`aws cloudwatch put-metric-alarm --alarm-name &quot;</span><span class="si">#{</span><span class="n">lb</span><span class="si">}</span><span class="sb"> UnHealthyHostCountUp&quot; --alarm-description &quot;</span><span class="si">#{</span><span class="n">lb</span><span class="si">}</span><span class="sb"> ELB UnHealthyHostCountUp&quot; \</span>
</span><span class='line'><span class="sb">  --actions-enabled \</span>
</span><span class='line'><span class="sb">  --ok-actions </span><span class="si">#{</span><span class="n">alert_sns</span><span class="si">}</span><span class="sb"> \</span>
</span><span class='line'><span class="sb">  --alarm-actions </span><span class="si">#{</span><span class="n">alert_sns</span><span class="si">}</span><span class="sb"> \</span>
</span><span class='line'><span class="sb">  --insufficient-data-actions </span><span class="si">#{</span><span class="n">alert_sns</span><span class="si">}</span><span class="sb"> \</span>
</span><span class='line'><span class="sb">  --metric-name &quot;UnHealthyHostCount&quot; \</span>
</span><span class='line'><span class="sb">  --namespace AWS/ELB \</span>
</span><span class='line'><span class="sb">  --statistic Maximum\</span>
</span><span class='line'><span class="sb">  --dimensions Name=LoadBalancerName,Value=</span><span class="si">#{</span><span class="n">lb</span><span class="si">}</span><span class="sb"> \</span>
</span><span class='line'><span class="sb">  --period 60 \</span>
</span><span class='line'><span class="sb">  --evaluation-periods 5 \</span>
</span><span class='line'><span class="sb">  --threshold 1 \</span>
</span><span class='line'><span class="sb">  --comparison-operator GreaterThanOrEqualToThreshold`</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iPhone水没した。高校サッカー準決勝見に行った。赤羽に飲みに行った]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2016/01/10/iphone-soccer/"/>
    <updated>2016-01-10T00:11:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2016/01/10/iphone-soccer</id>
    <content type="html"><![CDATA[<p>iPhone水没した。人生で二度目だ。トイレで諸所の動作をする時はスマホいじくるのやめよう。<br/>
高校サッカーの準決勝を見に行った。高校サッカー、本当に面白い。</p>

<p>東福岡の藤川虎太朗くんがとても良かった。<br/>
国学院久我山の澁谷雅也くんと名倉巧くんがとても魅力的だった。</p>

<p>神谷くんは我らが湘南ベルマーレに来てくれるのでこれからが楽しみだ。<br/>
見終わった後はおじさんたちで赤羽の町で飲み歩いた。話題は最初から最後まで最低だったが良い夜だった。<br/>
ただ、iPhoneはこわれたままなので明日修理屋持って行ってみようと思う。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[「学級崩壊立て直し請負人: 大人と子どもで取り組む「言葉」教育革命」を読んだ]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2015/12/20/broken-class/"/>
    <updated>2015-12-20T15:16:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2015/12/20/broken-class</id>
    <content type="html"><![CDATA[<p><a href="http://www.amazon.co.jp/%E5%AD%A6%E7%B4%9A%E5%B4%A9%E5%A3%8A%E7%AB%8B%E3%81%A6%E7%9B%B4%E3%81%97%E8%AB%8B%E8%B2%A0%E4%BA%BA-%E5%A4%A7%E4%BA%BA%E3%81%A8%E5%AD%90%E3%81%A9%E3%82%82%E3%81%A7%E5%8F%96%E3%82%8A%E7%B5%84%E3%82%80%E3%80%8C%E8%A8%80%E8%91%89%E3%80%8D%E6%95%99%E8%82%B2%E9%9D%A9%E5%91%BD-%E8%8F%8A%E6%B1%A0-%E7%9C%81%E4%B8%89/dp/4103343613%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3D13nightcrows-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4103343613" target="_blank" title="学級崩壊立て直し請負人: 大人と子どもで取り組む「言葉」教育革命"><img src="http://ecx.images-amazon.com/images/I/51p52cuC7NL.jpg" width="344" height="500" alt="学級崩壊立て直し請負人: 大人と子どもで取り組む「言葉」教育革命" /></a></p>

<p>ちょうど知り合いのおうちに遊びに行った時に<br/>
テレビでやっていて、興味が湧いたので読んでみた。</p>

<p>学校に関係するサービスをやっていて、詳しい人から色々な話は聞くが<br/>
実際に問題を解決している人はどのような方法で対処しているのかを知れてよかった。</p>

<h2>メモ</h2>

<ul>
<li>ほめ言葉のシャワー</li>
<li>成長を約束する</li>
<li>1年後に具体的にどこが成長できたか、成長ノートで確認をする</li>
<li>安心できる場を与える</li>
<li>子供ではなく人間を育てる</li>
<li>対話ノート。年百六十個のテーマについて</li>
<li>「父性」の欠如 = 「モンスターペアレンツ」</li>
<li>八対二」で止まらないようにする。「八」の中でスーパーＡをつくる</li>
<li>子供は褒められたい</li>
<li>「対話とは、話すことと聞くことの掛け算」</li>
<li>習慣化しない場合は自己責任で説明する。約束したよね、と</li>
<li>危ないな、というクラスはだいたい先生の目が下がっている。声が届いていない、教卓にしがみついているなど</li>
<li>今の時代、一人の大人が「Ｍ（mother＝母性）」「Ｆ（father＝父性）」「Ｃ（child＝無邪気さ）」を持たなくてはならない</li>
<li>厳しくやった後は、再び「眺める」という方法が有効になる</li>
<li>怒るとは、「自分中心の感情で相手に接すること」。叱るとは、「相手の存在を認め成長を願って強く意見すること」</li>
<li>一生懸命だと知恵が出る、中途半端だと愚痴が出る</li>
<li>全てに主語を入れて責任を持つようにする</li>
<li>家族でも絶対に譲れないものを３つつくる</li>
<li>反省ではなく内省ができるように</li>
<li>つねに全国レベルを意識しろ</li>
<li>「いいよ、頑張ってるからね。ずっと見守ってるからね、先生は」は効果がある。叱る時にも、「よくなるためのもの」とはっきりと伝える</li>
<li>現状の変化に対応できなかった先生が心の病で入院しがち</li>
</ul>


<p>色々と子供に求めがちな手法がよく聞こえるが、まずは自分たちから律していきたいものだ。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[「velocity」を読んだ]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2015/12/20/velocity/"/>
    <updated>2015-12-20T14:26:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2015/12/20/velocity</id>
    <content type="html"><![CDATA[<p><a href="http://www.amazon.co.jp/%E3%83%99%E3%83%AD%E3%82%B7%E3%83%86%E3%82%A3%E6%80%9D%E8%80%83-%E6%9C%80%E9%AB%98%E3%81%AE%E6%88%90%E6%9E%9C%E3%82%92%E4%B8%8A%E3%81%92%E3%82%8B%E3%81%9F%E3%82%81%E3%81%AE%E3%82%AF%E3%83%AA%E3%82%A8%E3%82%A4%E3%83%86%E3%82%A3%E3%83%96%E8%A1%93-%E3%82%A2%E3%82%B8%E3%83%A3%E3%82%BA%E3%83%BB%E3%82%A2%E3%83%BC%E3%83%A1%E3%83%83%E3%83%89/dp/4756242898%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3D13nightcrows-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D4756242898" target="_blank" title="ベロシティ思考-最高の成果を上げるためのクリエイティブ術-"><img src="http://ecx.images-amazon.com/images/I/31y4L6-%2BngL.jpg" width="342" height="500" alt="ベロシティ思考-最高の成果を上げるためのクリエイティブ術-" /></a></p>

<p>会社の本棚にあったので借りて読んだらめちゃくちゃおもしろかった。<br/>
今自分がどうしたらいいもんか、と悩んでいるところに適切に回答してくれていた。</p>

<h3>個人メモ</h3>

<ul>
<li>評価を1年に1度では遅い</li>
<li>アシュトンテイトの悲劇(決済報告が品質より優先された結果)</li>
<li>経営幹部の役割は迅速な意思決定と実験の推奨、スリムな組織体系を維持する</li>
<li>カリフォルニアには前向きな風がある</li>
<li>どれだけの収益に貢献できるかよりり、どれだけ人々の生活を便利に快適にするかからスタートしよう</li>
<li>優れた企業は細部にこだわる</li>
<li>顧客が欲しいものを顧客が欲しいと思う前に見つける</li>
<li>インスピレーションを与え、貢献し、情報や知識を提供しない限りマーケティングは環境汚染だ</li>
<li>&ldquo;Keep it stupid simple&rdquo;</li>
<li>貝にアイフォーンが入っていて海の音が聞こえる。聴覚は味覚を高める。体験という価値</li>
<li>「だからなに？どんなメリットがあるの？それのどこがいいの？」を繰り返す</li>
<li>チームで決断することと正しい決断をすることは全く別</li>
<li>それはシンプルで人間らしくて欠かせないものか</li>
<li>AKQA優れた人は価値観に共感できない組織では働きたがらず、自らが信頼するチームには喜んで参加する</li>
<li>常にアスリートだ</li>
<li>チャンスは無限にあるがリソースには限りがある</li>
</ul>


<p>冒頭の</p>

<blockquote><p>&ldquo;変化は「酸素」である。変化があるからこそ、ビジネスに活力が生まれ、ビジネスへの熱意が生まれる。
確立された方法が崩壊する時こそ、新しいエネルギーが入り込む余地が生まれ、従来の方法よりも<br/>
さらに良い方法で成功できるチャンスをつかめるのだ&rdquo;</p></blockquote>

<p>これが全てだった。思考停止してあの頃は良かったなぁ〜ってならないように<br/>
変化を楽しめるようにしてこう。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[2016年を質の高いものにするために集中力を高められそうな本をいくつか読んだ]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2015/12/20/for-the-mind/"/>
    <updated>2015-12-20T12:14:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2015/12/20/for-the-mind</id>
    <content type="html"><![CDATA[<p>もうすぐ今年も終わるということで</p>

<ul>
<li>子供がいるとなかなかまとまった時間がつくれない</li>
<li>業務時間の時間の密度を上げたい</li>
<li>効率的に物事にあたりたい</li>
</ul>


<p>この3点が今年の主な課題だった。<br/>
来年も今年と同じ感じで過ごすと職を失う可能性があるので<br/>
時間毎の質の向上を目指したい。</p>

<p>個人的な課題としては集中力と自制心、その場の自己の客観性が大きく欠けていると理解したので<br/>
来年はそれをどう改善するかということに注力していきたいのだが、<br/>
根本的には集中力の向上が全体的な生活の質の向上に繋がるんじゃあないかと思って<br/>
一旦本を何冊か読んでみた。</p>

<p>その個人的なメモ</p>

<hr />

<p><a href="http://www.amazon.co.jp/%E7%8F%BE%E4%BB%A3%E4%BA%BA%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E7%9E%91%E6%83%B3%E6%B3%95%E2%80%95%E5%BD%B9%E7%AB%8B%E3%81%A4%E5%88%9D%E6%9C%9F%E4%BB%8F%E6%95%99%E6%B3%95%E8%A9%B1%E3%80%884%E3%80%89-%E3%82%B5%E3%83%B3%E3%82%AC%E6%96%B0%E6%9B%B8-%E3%82%A2%E3%83%AB%E3%83%9C%E3%83%A0%E3%83%83%E3%83%AC%E3%83%BB%E3%82%B9%E3%83%9E%E3%83%8A%E3%82%B5%E3%83%BC%E3%83%A9-ebook/dp/B00BAO0HJE%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3D13nightcrows-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3DB00BAO0HJE" target="_blank" title="現代人のための瞑想法―役立つ初期仏教法話〈4〉 (サンガ新書)"><img src="http://ecx.images-amazon.com/images/I/412PsQac9cL.jpg" width="375" height="500" alt="現代人のための瞑想法―役立つ初期仏教法話〈4〉 (サンガ新書)" /></a></p>

<p>この本が一番おもしろかったです。<br/>
マインドフルネスも源流は同じかと。</p>

<p>そして、スマナサーラさんの本は全体的に面白い印象だ。<br/>
何故面白いのか、原始仏教は宗教である以前に精神の鍛錬や物事の観方を訓練するものであって<br/>
スマナサーラさんの本はその実践とその為の理解を助けてくれるので<br/>
読んだ後、自分でやってみようと思えるとこに面白さを感じるのかもしれない。</p>

<h3>いまだけをみる</h3>

<p>将来のことや過去のことのことにとらわれて今が見えなくならないように<br/>
今その瞬間を生きる</p>

<h3>やりたくないこととやりたいこと</h3>

<p>嫌だなって思う時点で怒りにとらわれている。これは本当に多いので反省点</p>

<h3>心というものは放っておくとどんどん悪くなる</h3>

<p>自然体なんてウソ。律しないとダメ</p>

<h3>ヴィパッサナー瞑想</h3>

<blockquote><p>ヴィパッサナーというのは、パーリ語で、「ヴィ（vi）」は「明確に」の意味で、「パッサティ（passati）」は「観察する、見る」という意味です。「明確に観察する」とは、どういうことでしょう？</p></blockquote>

<p>ヴィパッサナー瞑想の初歩的な解説が載っていた</p>

<ul>
<li><a href="http://www.jp.dhamma.org/940.html">日本ヴィパッサナー協会</a></li>
</ul>


<p>友人がこれに参加したことがあるので知っていた。いつか行ってみたい。</p>

<h3>事象に対して主観を取りのぞく</h3>

<p>主観「嫌いなヤツが嫌なこと言っているな〜」<br/>
客観「あの人が発音している」</p>

<p>雑音があっても「音」「音」「音」と認識することで<br/>
事象と自分の感情の結びつきをなくして心が事象に依存することをやめさせる。<br/>
これは瞑想系や仏教系の基本的な姿勢でよく見るものだ。</p>

<hr />

<p><a href="http://www.amazon.co.jp/%E3%83%96%E3%83%83%E3%83%80%E3%81%AE%E9%9B%86%E4%B8%AD%E5%8A%9B-%E5%BD%B9%E7%AB%8B%E3%81%A4%E5%88%9D%E6%9C%9F%E4%BB%8F%E6%95%99%E6%B3%95%E8%A9%B1-%E3%82%A2%E3%83%AB%E3%83%9C%E3%83%A0%E3%83%83%E3%83%AC%E3%83%BB%E3%82%B9%E3%83%9E%E3%83%8A%E3%82%B5%E3%83%BC%E3%83%A9-ebook/dp/B00LSURB5I%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3D13nightcrows-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3DB00LSURB5I" target="_blank" title="ブッダの集中力 役立つ初期仏教法話"><img src="http://ecx.images-amazon.com/images/I/51S428EvVPL.jpg" width="306" height="500" alt="ブッダの集中力 役立つ初期仏教法話" /></a></p>

<h3>たのしむこと</h3>

<p>極力無関心になった方が良いけど、批判的な無関心ではなく<br/>
楽しみをもって試みるべし。楽しみを持ってあたれば集中力は自然と増し<br/>
効率や能率を求めても結果はあまり付いてこない。</p>

<h3>やらないことをきめる</h3>

<p>仕事でもそうだけど、やること、やらなければならないことは無限にあるが<br/>
その中で理性的な無関心を育てていこうと。興味が起こった時は<br/>
貪瞋癡のいずれかによって生まれていないか、もしそうなっていたら<br/>
理性的な無関心によって捨ててこう。</p>

<h3>なににもとらわれていないという境地</h3>

<blockquote><p>つまり、「いま、こころに、欲もなく、怒りもなく、無知もありません。なにに対しても執着していません。ですから、究極に楽しいのです」</p></blockquote>

<p>ご飯を食べている時に幸福と感じることはあるが、隣りの人が怒鳴り声を上げて喧嘩したり<br/>
虫が出てきたりしたら一瞬で終わっちゃうので、そういうところに楽しみを見出すと疲れちゃうから<br/>
なにものにもとらわれていない最高の状態があることに気付いて、それを最良としよう。</p>

<h3>やりたいやりたくないではなく、必要か必要でないか</h3>

<p>きになること、やりたいことがあった時に「貪瞋癡」から来ているものでないか<br/>
確認しよう。そうであるなら理性的な無関心で捨てよう、そうでないなら楽しもう。<br/>
また、やりたい、やりたくないで選ぶのではなく、必要か必要ではないかで決めよう。</p>

<h3>肉体をそとからみる</h3>

<blockquote class="twitter-tweet" lang="en"><p lang="ja" dir="ltr">「みなさいごはうんちになるのだから、あまり腹を立てたりだとか、期待をしたりだとかすることを止めてみてはどうかね？キミの言うそれも、キミも、また、僭越ながらわたくしも、うんちなりに今を精一杯生きているのだから。けんじ」</p>&mdash; kenjiskywalker (@kenjiskywalker) <a href="https://twitter.com/kenjiskywalker/status/670023871462928384">November 26, 2015</a></blockquote>


<p> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>これと似たようなことが書いてあった。<br/>
ここまで品が悪くはもちろんない。</p>

<hr />

<p><a href="http://www.amazon.co.jp/%E4%B8%96%E7%95%8C%E3%81%AE%E3%83%88%E3%83%83%E3%83%97%E3%82%A8%E3%83%AA%E3%83%BC%E3%83%88%E3%81%8C%E5%AE%9F%E6%88%A6%E3%81%99%E3%82%8B%E9%9B%86%E4%B8%AD%E5%8A%9B%E3%81%AE%E9%8D%9B%E3%81%88%E6%96%B9-%E3%83%8F%E3%83%BC%E3%83%90%E3%83%BC%E3%83%89%E3%80%81Google%E3%80%81Facebook%E3%81%8C%E5%8F%96%E3%82%8A%E3%81%8F%E3%82%80%E3%83%9E%E3%82%A4%E3%83%B3%E3%83%89%E3%83%95%E3%83%AB%E3%83%8D%E3%82%B9%E5%85%A5%E9%96%80-%E8%8D%BB%E9%87%8E%E6%B7%B3%E4%B9%9F-ebook/dp/B015XS6RRI%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3D13nightcrows-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3DB015XS6RRI" target="_blank" title="世界のトップエリートが実戦する集中力の鍛え方　ハーバード、Google、Facebookが取りくむマインドフルネス入門"><img src="http://ecx.images-amazon.com/images/I/51D-yS7QLvL.jpg" width="309" height="500" alt="世界のトップエリートが実戦する集中力の鍛え方　ハーバード、Google、Facebookが取りくむマインドフルネス入門" /></a></p>

<ul>
<li>我々もアスリート。心を整えること。力まないこと。だらだらと続けずに準備をすること。</li>
<li>モンキーマインド、マインドフル・ウォーキング、ラベリング</li>
<li>言葉と脳の関係。言葉を選ぶことの大切さ</li>
<li>「あなたが仕事をしていくうえで、また生きていくうえで、最も大切にしたいと思っていることはなんですか」</li>
<li>瞬間を生きる</li>
</ul>


<p>基本的にはスマナサーラさんの法話と同じ。</p>

<h2>まとめ</h2>

<p>モンキーマインドという言葉を知れてよかった。自分はいつもこの状態にある。<br/>
ので、何かをやる時は必ず終わりを設けて、それが終わるまでは音や思考を、<br/>
外に置いて集中するようにしてみようと思う。<br/>
また、もう少し悪い言葉を発するときは2秒ぐらい置いて選べるようにする。<br/>
情報と行動の選択、やりたくないことではなくやらないといけないものを選んで進んでいく。<br/>
未来と過去ではなく、今その瞬間に集中する。</p>

<p>この点を注意して生きていければと思った。</p>

<hr />

<p><a href="http://www.amazon.co.jp/%E9%9B%86%E4%B8%AD%E5%8A%9B-%E3%82%BB%E3%83%AD%E3%83%B3%E3%83%BBQ%E3%83%BB%E3%83%87%E3%83%A5%E3%83%A2%E3%83%B3-ebook/dp/B008BCCLQU%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3D13nightcrows-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3DB008BCCLQU" target="_blank" title="集中力"><img src="http://ecx.images-amazon.com/images/I/41qk06z2hQL.jpg" width="342" height="500" alt="集中力" /></a></p>

<p>この本はあんまり得られるものはなかった。<br/>
本当になかったかKindleのハイライト見なおしてみたけどあまりなかった。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[もうやんカレーお持ち帰りという解脱の境地]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2015/12/08/curry-2015/"/>
    <updated>2015-12-08T17:48:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2015/12/08/curry-2015</id>
    <content type="html"><![CDATA[<p>この記事は<a href="http://www.adventar.org/calendars/725">カレー Advent Calendar 2015</a>の9日目の記事です。</p>

<p>今、とある事情で都庁前で働いているが、都庁前、空間設計が素晴らしく<br/>
まるで洗練された欧州の町並みを感じさせる(実際は地上と地下という概念があってファンタジー)。</p>

<p>そんな都庁前では、多種多様な飲食店があり、食べることにはまず困ることはない。<br/>
しかし、どうしても1000円前後の出費がかかってしまう。<br/>
それを避けたければ牛丼屋か、コンビニ、ビル内にある弁当屋で食べるという選択肢もあるが<br/>
どうも満たされない。そんな経験は誰にでもあるだろう。</p>

<p>そこで私がおすすめしたいのは<a href="http://www.moyan.jp">もうやんカレー</a>である。<br/>
もうやん？あそこはランチ1,000円だろ？何書いちゃってんのコイツ？<br/>
などと思われる方は題名を読んでくれ。お持ち帰りの話をしたいんだ。</p>

<p>お持ち帰り？カレー食べ放題のビュッフェという楽園を捨てて<br/>
貴様は何をほざいているんだ？と思われる方は年末年始は是非お寺に行って<br/>
煩悩を取り払ってくれ。</p>

<p>個人的にもうやんカレーの唯一のデメリットは「食べ過ぎてしまうこと」だった。<br/>
何故ならもうやんカレーはビュッフェスタイルを取っており、カレーが飲み放題なのだ。<br/>
これは仏教でいう三毒の中のひとつ、「貪」に該当するものだ。</p>

<p>何故、薬膳カレーのもうやんカレーをたべたのに毒を得る必要があるのか。<br/>
私はもうやんカレーを食べる度に悩み苦しんでいた。</p>

<p>そして、食べ終わった後オフィスに帰ると、食べ過ぎた反動で頭が働かなくなっているのだ。<br/>
私は怒りに震え、キーボードで頭を何度も叩き割ろうとした。「瞋」だ。</p>

<p>壊れたキーボードを眺めながら、冷静になった時に激しい後悔に襲わる。<br/>
「俺は地獄へ行く必要があるんだ。俺みたいなどうしようもない奴はどうせ地獄行きだ」<br/>
と愚痴り続け、仕事さえもままならない状態に至ってしまう。「癡」だ。</p>

<p>本来最高の食物であるもうやんカレーを食べることで、自己の制御ができず<br/>
貪り、怒り、愚痴り、私はいつも三毒の中心で悩み苦しんでいた。</p>

<p>そんなある日、同僚のエンジニア(仏陀)が言った。<br/>
「おもちかえりしましょう。630円で箱に詰めるだけなんで食べ過ぎないですよ」</p>

<p>これは悟りであり、解であった。目の前は大いなる光に包まれ<br/>
祝福の鐘は鳴り響き、心はどこまでも高く舞い上がっていった。</p>

<p>ということでもうやんカレーのおもちかえり630円、おすすめです。<br/>
個人的に米なし大量チキンでやらせて頂いています。</p>

<blockquote class="instagram-media" data-instgrm-captioned data-instgrm-version="6" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:50.0% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAAGFBMVEUiIiI9PT0eHh4gIB4hIBkcHBwcHBwcHBydr+JQAAAACHRSTlMABA4YHyQsM5jtaMwAAADfSURBVDjL7ZVBEgMhCAQBAf//42xcNbpAqakcM0ftUmFAAIBE81IqBJdS3lS6zs3bIpB9WED3YYXFPmHRfT8sgyrCP1x8uEUxLMzNWElFOYCV6mHWWwMzdPEKHlhLw7NWJqkHc4uIZphavDzA2JPzUDsBZziNae2S6owH8xPmX8G7zzgKEOPUoYHvGz1TBCxMkd3kwNVbU0gKHkx+iZILf77IofhrY1nYFnB/lQPb79drWOyJVa/DAvg9B/rLB4cC+Nqgdz/TvBbBnr6GBReqn/nRmDgaQEej7WhonozjF+Y2I/fZou/qAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"></div></div> <p style=" margin:8px 0 0 0; padding:0 4px;"> <a href="https://www.instagram.com/p/_BnizDpqs9/" style=" color:#000; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none; word-wrap:break-word;" target="_blank">解脱が具現化された様子です🍛</a></p> <p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;">A photo posted by kenjiskywalker (@kenjiskywalker) on <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2015-12-08T09:09:38+00:00">Dec 8, 2015 at 1:09am PST</time></p></div></blockquote>


<p> <script async defer src="//platform.instagram.com/en_US/embeds.js"></script></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[「お母さんの「敏感期」―モンテッソーリ教育は子を育てる、親を育てる」を読んだ]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2015/10/30/learning-montessori-system-fisrt/"/>
    <updated>2015-10-30T06:59:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2015/10/30/learning-montessori-system-fisrt</id>
    <content type="html"><![CDATA[<p>最近自分で考えて誰かに伝えることが疎かになってきているので<br/>
雑でも良いので書いていく。</p>

<p><a href="http://www.amazon.co.jp/%E3%81%8A%E6%AF%8D%E3%81%95%E3%82%93%E3%81%AE%E3%80%8C%E6%95%8F%E6%84%9F%E6%9C%9F%E3%80%8D%E2%80%95%E3%83%A2%E3%83%B3%E3%83%86%E3%83%83%E3%82%BD%E3%83%BC%E3%83%AA%E6%95%99%E8%82%B2%E3%81%AF%E5%AD%90%E3%82%92%E8%82%B2%E3%81%A6%E3%82%8B%E3%80%81%E8%A6%AA%E3%82%92%E8%82%B2%E3%81%A6%E3%82%8B-%E6%96%87%E6%98%A5%E6%96%87%E5%BA%AB-%E7%9B%B8%E8%89%AF-%E6%95%A6%E5%AD%90/dp/416771745X%3FSubscriptionId%3D0AVSM5SVKRWTFMG7ZR82%26tag%3D13nightcrows-22%26linkCode%3Dxm2%26camp%3D2025%26creative%3D165953%26creativeASIN%3D416771745X" target="_blank" title="お母さんの「敏感期」―モンテッソーリ教育は子を育てる、親を育てる (文春文庫)"><img src="http://ecx.images-amazon.com/images/I/413Pf23jBaL.jpg" width="342" height="500" alt="お母さんの「敏感期」―モンテッソーリ教育は子を育てる、親を育てる (文春文庫)" /></a></p>

<p>最近いろいろと知る機会があってモンテッソーリの書いてある本を読んでみたくて読んだ。<br/>
個人的に子供と接する時に気を付けているのは</p>

<ul>
<li>この世界に絶対はないこと</li>
<li>物事の背景を理解するようにすること</li>
<li>何歳であろうと一人の人間として丁寧に物事を教えること</li>
<li>やりたいものはやらせて自分の頭で学ばせること</li>
</ul>


<p>この辺を気を付けていたけど、モンテッソーリはもう少し体系的に<br/>
より高度に実践しているようだった。<br/>
ちゃんとした教材を読んでみたくなった。</p>

<p>あと秩序の話で、朝うんち流しちゃってずっとうんちうんち言われてたのが一番面白かった</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[YAPC::Asia 2015で冗長化に失敗した話をしてきました #yapcasia]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2015/08/22/yapcasia2015/"/>
    <updated>2015-08-22T12:59:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2015/08/22/yapcasia2015</id>
    <content type="html"><![CDATA[<p><img src="https://dl.dropboxusercontent.com/u/5390179/moris-mirakui.png" alt="" /></p>

<blockquote><p>発表用資料の1ページ</p></blockquote>

<h2><a href="http://yapcasia.org/2015/talk/show/f2816038-10ec-11e5-89bf-d7f07d574c3a">我々はどのように冗長化を失敗したのか / YAPC::Asia TOKYO 2015</a></h2>

<p>この発表をしてきました。</p>

<p>前日の<a href="http://hitode909.hatenablog.com/entry/2015/08/21/165932">hitode909さんの発表</a>や、<a href="https://speakerdeck.com/fujiwara3/consultozi-zuo-osswohuo-yong-sita100tai-gui-mo-falsewebsabisuyun-yong">fujiwaraさんの発表</a>を見て、</p>

<p>ああ、自分はなんて見づらいスライドをつくってしまったんだ。という反省をして<br/>
154枚もあるし、後ろの人が見づらいだろうなと感じたので<br/>
(そもそもそれぐらい人が聞きに来てくれればだけど&hellip;)<br/>
先にスライドを公開しておいて、そちらを参照してもらうようにしました。</p>

<blockquote class="twitter-tweet" lang="ja"><p lang="ja" dir="ltr">11:10からの話のスライド、見づらいものつくってしまって、後ろの席の人は見づらいと思うので先にスライドアップロードしています。見づらい場合はこちらを見て下さい🙏 <a href="https://t.co/jwYtO03jU1">https://t.co/jwYtO03jU1</a> <a href="https://twitter.com/hashtag/yapcasiaD?src=hash">#yapcasiaD</a></p>&mdash; kenjiskywalker (@kenjiskywalker) <a href="https://twitter.com/kenjiskywalker/status/634905926533644288">2015, 8月 22</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>この方法は良かった印象がある。<br/>
で、スライドはこちらになります</p>

<div style="width: 65%">
<script async class="speakerdeck-embed" data-id="cde37ad797ab49dd92584770e9798d9a" data-ratio="1.33333333333333" src="//speakerdeck.com/assets/embed.js"></script>  
</div>




<blockquote class="twitter-tweet" data-cards="hidden" lang="en"><p lang="ja" dir="ltr">Nice try / SpeakerDeckでかい問題は <a href="http://t.co/MKonnBdKsX">http://t.co/MKonnBdKsX</a> で解決ですよ / “YAPC::Asia 2015で冗長化に失敗した話をしてきました <a href="https://twitter.com/hashtag/yapcasia?src=hash">#yapcasia</a> - さよならインター…” <a href="http://t.co/l3F9su5RCE">http://t.co/l3F9su5RCE</a></p>&mdash; Uchio KONDO (@udzura) <a href="https://twitter.com/udzura/status/635644624120340481">August 24, 2015</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<blockquote><p>うづらさんありがとうございます！</p></blockquote>

<p>何回か発表の練習したんですが、何回やっても時間過ぎなくて、<br/>
本当かな〜って思ったんだけど緊張しながら話すとやっぱり色々うまく行かなくて<br/>
ちょくちょく時間を気にして早く話しちゃったところとか、上手く話せないところとかあって<br/>
ちゃんと伝えたかったことが上手く伝えられたか不安になったけど<br/>
去年よりかはまともにできたっぽくて、共感してもらえたところも結構あったようで発表できて良かった。<br/>
とてもたくさんの人が聞きに来てくれて嬉しかったです。聞きに来てくれてありがとうございました。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[YAPC::Asia 2015 で冗長化に失敗した話を話します]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2015/08/16/preview-yapcasia2015-mytalk/"/>
    <updated>2015-08-16T23:24:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2015/08/16/preview-yapcasia2015-mytalk</id>
    <content type="html"><![CDATA[<p>今年もYAPCで発表させて頂くことになりました。<br/>
投票してくれた方、ありがとうございます。</p>

<h2><a href="http://yapcasia.org/2015/talk/show/f2816038-10ec-11e5-89bf-d7f07d574c3a">我々はどのように冗長化を失敗したのか / YAPC::Asia 2015</a></h2>

<p>追記にも記載しましたが、</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>挑戦したこと
</span><span class='line'>冗長化について
</span><span class='line'>Redis + Redis Sentinel
</span><span class='line'>Consul
</span><span class='line'>MySQL + mysqlfailover
</span><span class='line'>consul-template
</span><span class='line'>hostsの順番
</span><span class='line'>クラウドという名の混乱
</span><span class='line'>対応
</span><span class='line'>冗長化の終わり、そして</span></code></pre></td></tr></table></div></figure>


<p>という内容になりそうです。色々なソフトウェアを利用し、ある思想を持って冗長化にチャレンジしたが<br/>
アマチュアのような見積り、構成の甘さや、インフラではなくプロジェクト全体の問題などを含め<br/>
改めて実体験として経験したこと、改めて大切だと理解したことなどをお話しできればと考えています。</p>

<p>Webサービスを運用しているけど、インフラ担当なんていない、<br/>
サーバ管理はよーわからんが新しいことにチャレンジしてみたい！けれど失敗はしたくない、<br/>
など、インターネットにいるようなすごい人達ではなくてもチャレンジすることができるが<br/>
こういう失敗はしないようにね、という反面教師のお話を聞きに来て頂ければと思います。</p>

<p>当日はどうぞよろしくお願いいたします。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[RailsのARで取ってきたオブジェクトにアクセスする]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2015/08/08/access-element-in-rails-controller-object/"/>
    <updated>2015-08-08T20:57:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2015/08/08/access-element-in-rails-controller-object</id>
    <content type="html"><![CDATA[<p>考えたら当たり前なんだけど</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mysql&gt; desc people;
</span><span class='line'>+---------------+--------------+------+-----+---------+----------------+
</span><span class='line'>| Field         | Type         | Null | Key | Default | Extra          |
</span><span class='line'>+---------------+--------------+------+-----+---------+----------------+
</span><span class='line'>| id            | int(11)      | NO   | PRI | NULL    | auto_increment |
</span><span class='line'>| name          | varchar(255) | YES  |     | NULL    |                |
</span><span class='line'>| prefecture    | varchar(255) | YES  |     | NULL    |                |
</span><span class='line'>| created_at    | datetime     | YES  |     | NULL    |                |
</span><span class='line'>| updated_at    | datetime     | YES  |     | NULL    |                |
</span><span class='line'>+---------------+--------------+------+-----+---------+----------------+
</span><span class='line'>7 rows in set (0.00 sec)
</span><span class='line'>
</span><span class='line'>mysql&gt;</span></code></pre></td></tr></table></div></figure>


<p>みたいなものがあってView側で</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@prefecture_name = People.group(:prefecture)</span></code></pre></td></tr></table></div></figure>


<p>みたいな感じでprefectureをまとめておいて<br/>
プルダウンでprefectureを選択してsubmitして</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;%= form_tag({:action=&gt;"list"}, {:method=&gt;"get"}) do %&gt;
</span><span class='line'>  # all_peoplesはpeoples
</span><span class='line'>  &lt;%= select_tag 'prefecture', options_from_collection_for_select(@prefecture_name, "prefecture", "prefecture") %&gt;
</span><span class='line'>  &lt;%= submit_tag 'subsubsub' %&gt;
</span><span class='line'>&lt;% end %&gt;</span></code></pre></td></tr></table></div></figure>


<p>で<code>prefecture</code>を<code>params</code>で受け取れるようにしておいて</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  def list
</span><span class='line'>    @people_selected_by_prefecture = People.where(prefecture: params[:prefecture])
</span><span class='line'>  end</span></code></pre></td></tr></table></div></figure>


<p>みたいな感じでControllerで選択されたprefectureでレコードを抜いておいて</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;% @people_selected_by_prefecture.each do |p| %&gt;
</span><span class='line'>  &lt;%= p.name %&gt; | &lt;%= p.prefecture %&gt;&lt;br&gt;
</span><span class='line'>&lt;% end %&gt;</span></code></pre></td></tr></table></div></figure>


<p>みたいな感じでプルダウンで選んだprefectureに該当する人間を選ぶ<br/>
みたいな感じ</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;% @people_selected_by_prefecture.each do |p| %&gt;
</span><span class='line'>  &lt;%= p[0] %&gt; | &lt;%= p[1] %&gt;&lt;br&gt;
</span><span class='line'>&lt;% end %&gt;</span></code></pre></td></tr></table></div></figure>


<p>とかでやろうとしていたけどそもそもHashではない</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[curlでcurl: (51) SSL: certificate verification failed (result: 5)が出る時の対処法]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2015/08/05/curl-ssl-certificate-verification-failed/"/>
    <updated>2015-08-05T18:24:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2015/08/05/curl-ssl-certificate-verification-failed</id>
    <content type="html"><![CDATA[<blockquote><p>OS X Yosemite 10.10.4</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl: (51) SSL: certificate verification failed (result: 5)</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>🙏  ruby -ropenssl -e "p OpenSSL::X509::DEFAULT_CERT_FILE"
</span><span class='line'>"/usr/local/etc/openssl/cert.pem"
</span><span class='line'>🙏
</span><span class='line'>🙏
</span><span class='line'>🙏  cd /usr/local/etc/openssl/
</span><span class='line'>🙏
</span><span class='line'>🙏  curl -O http://curl.haxx.se/ca/cacert.pem
</span><span class='line'>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span><span class='line'>                                 Dload  Upload   Total   Spent    Left  Speed
</span><span class='line'>100  252k  100  252k    0     0  55123      0  0:00:04  0:00:04 --:--:-- 58321
</span><span class='line'>🙏
</span><span class='line'>🙏  mv cacert.pem cert.pem</span></code></pre></td></tr></table></div></figure>


<p>で解決できた。正しいかどうかは知らん。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[夏が暑いのでIRKitとRobotyとSlackを使って帰る前にエアコンをつけるようにした]]></title>
    <link href="http://blog.kenjiskywalker.org/blog/2015/08/02/irkit-ruboty-slack/"/>
    <updated>2015-08-02T01:08:00+09:00</updated>
    <id>http://blog.kenjiskywalker.org/blog/2015/08/02/irkit-ruboty-slack</id>
    <content type="html"><![CDATA[<p>Ruboty、nodeの書き方思い出さなくても良いし<br/>
何よりRubyのエコシステムに乗っかれるのが最高だ。<br/>
ruboty自体はRaspiの上にsupervisorで動かしている。</p>

<p>子供もまだちっさいのでこれで少しは便利になったかな</p>

<p><img src="http://i.gyazo.com/e2d4fa1dfbf708d1fc08315ed4ef059e.png" alt="" /></p>

<ul>
<li><a href="http://getirkit.com/">IRKit</a></li>
<li><a href="http://www.amazon.co.jp/gp/product/B00T356SFO/ref=as_li_ss_tl?ie=UTF8&amp;camp=247&amp;creative=7399&amp;creativeASIN=B00T356SFO&amp;linkCode=as2&amp;tag=13nightcrows-22">Raspi2</a></li>
<li><a href="https://github.com/r7kamura/ruboty">ruboty</a></li>
<li><a href="https://github.com/rosylilly/ruboty-slack_rtm">ruboty-slack_rtm</a></li>
<li><a href="http://qiita.com/tbpgr/items/e3c6544e6bd9533bc71f">Ruboty | Ruboty Plugin を RubyGems に公開せずに利用する #ruboty</a></li>
</ul>

]]></content>
  </entry>
  
</feed>
