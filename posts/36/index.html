
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>さよならインターネット</title>
  <meta name="author" content="kenjiskywalker">

  
  <meta name="description" content="本読むより人のコード読んだ方が勉強なるけど
こういう所作の話全然知らないから面白かった。 自分メモ ワンラインでシュッっとさせてわかりづらくなるならそれは止めた方が良い
汎用的な単語を使うのを止める。直接的で何をしているのかわかりやすい単語を使う
hosts,status,get,list, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.kenjiskywalker.org/posts/36/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="さよならインターネット" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37377904-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">さよならインターネット</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="main-navigation">
  <li><a href="/">Goodbye The Internet.</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/03/art-of-readable-code/">リーダブルコード読んだ</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-03T14:18:00+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.amazon.co.jp/gp/product/4873115655/ref=as_li_qf_sp_asin_il?ie=UTF8&camp=247&creative=1211&creativeASIN=4873115655&linkCode=as2&tag=13nightcrows-22"><img border="0" src="http://ws-fe.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=4873115655&Format=_SL160_&ID=AsinImage&MarketPlace=JP&ServiceVersion=20070822&WS=1&tag=13nightcrows-22" ></a><img src="http://ir-jp.amazon-adsystem.com/e/ir?t=13nightcrows-22&l=as2&o=9&a=4873115655" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></p>

<p>本読むより人のコード読んだ方が勉強なるけど<br/>
こういう所作の話全然知らないから面白かった。</p>

<h3>自分メモ</h3>

<ul>
<li>ワンラインでシュッっとさせてわかりづらくなるならそれは止めた方が良い</li>
<li>汎用的な単語を使うのを止める。直接的で何をしているのかわかりやすい単語を使う<br/>
hosts,status,get,list,この辺汎用的な名前付けがちなのでわかりやすいようにする</li>
<li>スコープが小さければx,yとか使っても良いけど目視で追い切れないところで使うと追う手間が発生する</li>
<li>コメントで補う前にコードや変数名をよしなにできないか考える</li>
<li>ループロジックは簡潔に、かつそれぞれのメソッドがわかりやすいように</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/31/serverspec-attribute/">Serverspecでchefのjsonを読み込む</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-31T09:48:00+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>2013/12/25 update</p></blockquote>

<p><a href="http://blog.kenjiskywalker.org/blog/2013/07/13/serverspec-chef-cookbook/">Testing #chef Cookbook by #serverspec #devops</a>の続きみたいなものですが<br/>
Chefのjsonファイルでフラグ立てたりしてると、そのフラグによって<br/>
テスト対象が変化する場合があるかと思います。<br/>
その場合、<a href="http://serverspec.org/">serverspec</a>にはpropertyの機能があるのでそれを利用します。</p>

<h2>spec/spec_helper.rb</h2>

<div><script src='https://gist.github.com/6118553.js?file=spec_helper.rb'></script>
<noscript><pre><code></code></pre></noscript></div>


<p><code>set_property</code>の項目を追加します。</p>

<h2>nodes/host.json</h2>

<div><script src='https://gist.github.com/6118553.js?file=nodes_host.json'></script>
<noscript><pre><code></code></pre></noscript></div>


<p>こんな感じでこのMySQLはSlaveですみたいなフラグがあって</p>

<h2>cookbooks/mysql/templates/default/my.cnf.erb</h2>

<div><script src='https://gist.github.com/6118553.js?file=cookbooks_mysql_templates_default_my.cnf.erb'></script>
<noscript><pre><code></code></pre></noscript></div>


<p>こんなテンプレートがあったら</p>

<h2>cookbooks/mysql/spec/is_slave_spec.rb</h2>

<div><script src='https://gist.github.com/6118553.js?file=cookbooks_mysql_spec_is_slave_spec.rb'></script>
<noscript><pre><code></code></pre></noscript></div>


<p>このように<code>property["mysql"]["is_slave"]</code>として値を利用することができます。</p>

<blockquote><p>specファイル、<code>if ~ end</code>で囲ってるのがモサいので、良案をお待ちしております</p></blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/30/miyako-osusume/">2013年 宮古島で最高の夏情報</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-30T23:13:00+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近宮古島行ってきたのでおすすめ情報載せますね。</p>

<p><img src="https://dl.dropboxusercontent.com/u/5390179/miyako-soba.png" alt="https://dl.dropboxusercontent.com/u/5390179/miyako-soba.png" /></p>

<h1>レンタカー</h1>

<p>島１周するのに２時間もあれば周れるので、レンタカーおすすめします。<br/>
伊良部島行きたい場合はレンタカーに確認しておいた方が良いです。<br/>
沖縄本島と比べると日差しが全然違うので<br/>
歩いてとか移動するとだいぶつらいと思う。</p>

<p>お金あるなら毎回タクシーでも良いかもしれない。<br/>
１人ツール・ド・宮古島やるなら夏避けないと無理っぽい。<br/>
信号はほとんどないので優雅なドライブできておすすめです。</p>

<h1>宿泊先</h1>

<p>東急リゾートとか海の近くも良いけど<br/>
メシ屋が大量にある平良付近をおすすめします。</p>

<p>海の近くが良いとか思うかもしれないですが、<br/>
海岸自体はどれも小さくて、色んなところにあるので<br/>
朝起きたら海を見たい or ホテルで引きこもりメインの旅行<br/>
でなければ、利便性とかお店がたくさんある繁華街のホテルをおすすめします。</p>

<h1>飯屋</h1>

<h2><a href="http://www.churashima.net/gourmet/soba_museum/miyako/kikuei.html">菊栄食堂</a></h2>

<p>ベーシックな宮古そばが500円で食べれるのでおすすめ。<br/>
バックパッカーみたいな人が悩んで肉そば頼んでて<br/>
肉、めちゃめちゃ乗っかってエッ！？ってなってた。</p>

<p>宮古島の人に聞いたら、宮古島の人は安くてたくさん食べたいんだって言ってた。</p>

<h2><a href="http://tabelog.com/okinawa/A4705/A470503/47008385/">ハイサイ居酒屋</a></h2>

<p>食べ飲み放題3000円っていうのがあって<br/>
いやー、これで食べ飲み放題3000円かーって言ってたべてて<br/>
肉ばっかりだったからサラダとかあります？って聞いて<br/>
あとで出すよ！って言われて待ってたら<br/>
餃子１２個乗っかったサラダ出てきて、？？？ってなって<br/>
え、これもですか？って聞いたら足りない？まだ出すよ？って言われて<br/>
大丈夫です。って言った。宮古島の質量を実感した夕飯だった。</p>

<p>シークワーサーサワーが絶品だった。<br/>
ここ以外のお店でもシークワーサーサワー飲んだけど<br/>
多分都内の沖縄料理屋の方が質が良いと思う。</p>

<p>最終日シークワーサーサワー飲みたくてまた行った。</p>

<h2><a href="http://park20.wakwak.com/~chanoma/index.htm">まなつスパイスカフェ茶音間</a></h2>

<p>オシャレ系カレー屋さん。スパイス効いてて美味しい。</p>

<h2><a href="http://miyako-kihachi.com/">宮古牛喜八</a></h2>

<p>店員さんが面白い。閉店の時間だったけどボクシング最後まで見てた。<br/>
厚切りタンが美味い。</p>

<h2><a href="http://www.dougsburger.com/">DOUG&rsquo;S BURGER</a></h2>

<p>ダグズ・バーガー美味い。オニオンリングも美味い。コーヒーも美味かった。<br/>
元ライブドア社長の照井さんのご兄弟が経営されてるらしい。<br/>
ダグ氏、ずっとアメリカ人だと思ってた。</p>

<h2><a href="http://www.ritou.com/spot/view-miyako-m117.html">二枚屋</a></h2>

<p>2000円で飲み食べ放題。バイキング形式で近くでとれるカツオが並んでたりした。<br/>
安くたらふく呑んで食う。ザ・宮古島スタイルのお店だった。</p>

<h2><a href="https://sites.google.com/site/nemamangofarm/">亜熱帯工房 宮古島</a></h2>

<p>マンゴーつくってるところでマンゴージュース飲める。めちゃ美味い。<br/>
マンゴーのピクルスが絶品だった。</p>

<h2>マリンスポーツ</h2>

<p>シュノーケル、ツアーとか使わないでも吉野海岸行けば<br/>
市が運営してる海の家で道具借りれて、目の前珊瑚だらけで魚いっぱいいるらしい。</p>

<h2>やたら離島すすめてくるヤツ</h2>

<p>の気持ちわかった。海、大体貸し切り状態だったし<br/>
信号ほとんどなかったし、普段人がたくさんいるところでイライラしたり<br/>
インターネットとかでせかせかしてる意味何なんだろうとか<br/>
人にとっての幸せって何なんだろうとか考えるヤツの気持ちもわかった。</p>

<h2>現地のヤンキーっぽい女の子のおすすめのお店</h2>

<p>居酒屋しか知らないらしくて穴場とか知らないって言ってた。<br/>
ひとつおすすめされたお店行ったけど都内にあるような普通の店だった。</p>

<p>かわいい現地の女の子に声かけまくるの<br/>
カミさんに怒られるから気を付けた方がいい。</p>

<h2>最高の夏</h2>

<p><img src="https://dl.dropboxusercontent.com/u/5390179/saiko-natsu.png" alt="https://dl.dropboxusercontent.com/u/5390179/saiko-natsu.png" /></p>

<p>アイツらと行った宮古島の思い出、最高の夏</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/18/kiga-to-sensou/">「飢餓と戦争の戦国を行く」を読んだ</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-18T22:03:00+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.amazon.co.jp/gp/product/4022597879/ref=as_li_qf_sp_asin_il?ie=UTF8&camp=247&creative=1211&creativeASIN=4022597879&linkCode=as2&tag=13nightcrows-22"><img border="0" src="http://ws-fe.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=4022597879&Format=_SL160_&ID=AsinImage&MarketPlace=JP&ServiceVersion=20070822&WS=1&tag=13nightcrows-22" ></a><img src="http://ir-jp.amazon-adsystem.com/e/ir?t=13nightcrows-22&l=as2&o=9&a=4022597879" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></p>

<h3>「七度の餓死に遇うとも、一度の戦いに遇うな」</h3>

<ul>
<li>1150年 ~ 1600年のデータ</li>
<li>応仁の乱前は3 ~ 5年に1回の割合で間欠的、集中的に飢饉と疫病が起きていた</li>
<li>応仁の乱後は2年に1回の割合で慢性的に飢饉と疫病が起きていた</li>
<li>天災の34%が旱魃、66%が長雨だった</li>
<li>「町にはぶらぶら遊んでいる人ばかりで、農民の姿は少ない。必死に耕している人もいるが、聞こえてくるのは飢民が食を乞う声ばかりだ。日本には人は多いが、飢人もまた多く、疫病で動けなくなっている人も多い。彼らはいたるところの路ばたに集まってすわり、通る人ごとに銭を乞うている。」</li>
</ul>


<h2>生命維持の習慣</h2>

<ul>
<li>鎌倉時代、飢饉が発寛喜の飢饉をうけて、幕府は時限的に飢民奴隷精度を設けた</li>
<li>内容は、飢饉の年に誰かがもし飢えた人を買い取って養えば、養育の功労として奴隷にしてもいい</li>
<li>ただし人身売買は本来は国禁である</li>
<li>故に、これは飢饉の年だけの時限立法である</li>
<li>飢饉が去った後、売主が飢餓発生時に超安値で売った価格で買い戻そうとしても、それは無効である</li>
<li>売主と買主が双方合意しているのであれば、問題はない。など</li>
<li>ある宣教師のメモ「父親たちは、極度の貧窮に迫られた際に、自分たちの子供を売る、という習慣を今でも持っている」</li>
<li>北条泰時の施策<a href="http://d.hatena.ne.jp/Wallerstein/20090118/1232247150">『吾妻鏡』寛喜三年三月十九日条所収の北条泰時奉書－追加法２０ / 我が九条</a></li>
<li>田麦に税をかけてはならぬ</li>
<li>二毛作が流行った頃、百姓の夏の麦作ばかりが倍増して、領主は空きの年貢がろくに取れなかった。制限しようとするも、百姓たちは聞く耳持たず。麦年貢を徴収しようとしても、百姓たちは言うことを聞かない</li>
<li>百姓たちは田麦に精を出し、水田の稲の作付けが遅れ、水不足になる。百姓たちは日照りが原因だと年貢減免を言い立てる。 &lt;= 面白い</li>
</ul>


<h2>応仁の乱</h2>

<ul>
<li>応仁の乱の46年前に応永の大飢饉が発生する</li>
<li>翌年の春、都周辺の国々は深刻な飢餓と疫病に襲われる</li>
<li>周辺の国々から飢えた貧しい人々が難民となって京に殺到する</li>
<li>飢餓難民を救おうと、鴨川の五条の河原で仮小屋を設けて難民を収容し、粥の施しなどを行った。京にはまだ食料のゆとりはあった</li>
<li>粥を急に食べたのが命取りとなり、衰弱した人々の間には疫病も広がり、難民たちは尽く死んでいった</li>
<li>諸国の飢餓難民はまず山野、江河に食物を求めて殺到し、それも尽きると京に向かって物乞いの大きな奔流となっていった</li>
<li>食料生産地の村々が、大消費地の京より先に飢えた</li>
<li>難民たちの殺到で、ついには京も二次飢饉に襲われた</li>
<li>応仁の乱の24年前に嘉吉の大飢饉が発生する</li>
<li>「天下飢饉し、悪党充満す」といわれ、夜ごと高利貸しが襲われた</li>
<li>辺境の村が飢えると、生き延びるために京を目指し、時には高利貸しや富商を襲った</li>
<li>応仁の乱の20年前、台風、洪水、炎早による凶作、三日病や咳病流行る</li>
<li>徳政の土一揆起こる</li>
<li>応仁の乱の7年前、河内では畠山家の内戦が四年続いており、凶作と飢饉を加速させていた</li>
<li>寛正の大飢饉起こる。京には餓死者が山を成すほどであった</li>
<li>京は流入型飢饉とよばれる二次飢餓に襲われる</li>
<li>ある禅僧は嘆く「諸国の炎早、連年の災い」</li>
<li>食の乏しい端境期の三月になると、餓死者は鴨川にあふれて流れをふさぐほどだった</li>
<li>ある高僧曰く「去年は諸国が旱魃に襲われた。諸国ではお家騒動の戦乱が続き、領内の人は戦争難民、飢饉難民となり、京に流れ込んで餓死し、疫病まで広がっている。これは御成敗の不足、足利義政の政治が問題である」</li>
<li>飢饉発生時、金持ちは私財を投じ、難民は労働を施し、寺や橋、住宅をつくる事業モデルがあった</li>
<li>西芳寺では「ただ人に物を食わせ、何のなすことも無うては、その身のためにも悪い」と荒れた庭の修復作業を行い、労働に応じて食べ物を与えた</li>
<li>東大寺の再建を行った重源も同じように飢餓に苦しむ周防の人たちを雇い、食料と働き口を提供し、安く済ませることに成功している</li>
<li>足利義政の悪政の代表例である花の御所の復旧も、このモデルに沿ったものであったのではないか</li>
<li>何故生産者から先に飢餓難民になるのか。それは余剰分を都市へ分配しているのではなく、決められた作付けが強制され、それを上納することで村の生活の保証がされていた</li>
<li>この偏った受給システムにより、生産地がまず飢え、生き延びるために富が集中していた首都を目指したのではないか</li>
<li>一揆も頻繁に発生していた。<a href="http://ja.wikipedia.org/wiki/%E5%98%89%E5%90%89%E3%81%AE%E5%BE%B3%E6%94%BF%E4%B8%80%E6%8F%86">嘉吉の徳政一揆</a>が有名である</li>
<li>足軽の発生。応仁の乱発生時、土一揆が消え、戦場となった都には<a href="http://ja.wikipedia.org/wiki/%E8%B6%B3%E8%BB%BD">足軽</a>が大量に現れた</li>
<li>足軽とさえいえば、略奪も野放しであった</li>
<li>足軽は歴史的建造物も略奪の対象だった。その盗品を狙って商人が集まり、闇市が行われていた</li>
<li>寺宝を盗まれると、信者が闇市まで行き、買い取って寄付をしていた</li>
<li>足軽たちのルーツは周辺の貧民や浮浪民、また難民などであったのではないか。戦場の戦いは土一揆と同じ下克上の動きであり、第飢饉と過酷な搾取を生き延びてきた義憤の度合いが強く、故に富や物を盗むことに抵抗はなかったのではないか。という視点もある</li>
</ul>


<h2>奴隷売買</h2>

<ul>
<li>戦国時代になると、敵軍に攻められた村は奴隷狩りにあった</li>
<li>敵軍に攻められた村の村人は、衣類を身ぐるみ剥がされたり、田畑を荒らされたりした</li>
<li>女子供は強姦された。戦国時代、少年は男色の対象であったので、少女と同じように強姦の対象であった</li>
<li>大航海時代であったので、日本人が日本人の奴隷を売買し、島原からスペイン、ポルトガルの奴隷船に連れられマカオなどに売られていった</li>
<li>スペイン人に買われた少女の奴隷は、性奴隷となった</li>
</ul>


<h2>村の城</h2>

<ul>
<li>このように、戦国時代に敵軍に捉えられると悲惨な待遇が待ち受けているので、村人たちは自衛手段を持っていた</li>
<li>敵が攻めてきた場合は、金品を穴や井戸などに隠し、領内の城へ逃げた。城には戦闘員が２割で、残りの８割は逃げてきた村人という状態をよく見た</li>
<li>裏山などに村の城と呼ばれる避難用のエリアを用意していた。用意していたとは言うものの、軽い井戸があるだけや、木々を切り倒したものぐらいで、屋根などはない</li>
<li>村の武装用に穢多・非人を雇っていた。 &lt;= 差別対象として書かれていたが、差別対象になるのは江戸時代からなので、ここら辺の記述は要確認</li>
</ul>


<p>後半雑になったけど、取り敢えず何で応仁の乱でそんなに神仏の類のものが壊れたのか<br/>
戦国時代の村人はどうだったのかがなんとなく見えて面白かった。<br/>
特に応仁の乱については色々と疑問に思っていたところがあっただけに、難民流入と足軽の強奪という２点で、だいぶ納得がいった。</p>

<p>江戸時代前は本当に今の常識が通じないすごい世界だ。<br/>
しかし今までで１番長いエントリーだしこれからもこれを超えるエントリー書けなさそうだし業が深い</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/17/chef-run_list/">Chefの中身読んで、外部からrun_listを利用する</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-17T00:29:00+09:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>run_listを渡してるところを探した。<br/>
といってもほとんど<a href="https://twitter.com/soh335">@soh335</a>が教えてくれた。さすが一流エンジニアだ。</p>

<p><code>/chef/lib/chef/run_list.rb</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def expansion_for_data_source(environment, data_source, opts={})
</span><span class='line'>  case data_source.to_s
</span><span class='line'>  when 'disk'
</span><span class='line'>    RunListExpansionFromDisk.new(environment, @run_list_items)
</span><span class='line'>  when 'server'
</span><span class='line'>    RunListExpansionFromAPI.new(environment, @run_list_items, opts[:rest])
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>ここが怪しかった。</p>

<p><code>/chef/spec/unit/run_list_spec.rb</code></p>

<p>ここ見たら</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>describe "from disk" do
</span><span class='line'>  it "should load the role from disk" do
</span><span class='line'>    Chef::Role.should_receive(:from_disk).with("stubby")
</span><span class='line'>    @run_list.expand("_default", "disk")
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  it "should log a helpful error if the role is not available" do
</span><span class='line'>    Chef::Role.stub!(:from_disk).and_raise(Chef::Exceptions::RoleNotFound)
</span><span class='line'>    Chef::Log.should_receive(:error).with("Role stubby (included by 'top level') is in the runlist but does not exist. Skipping expand.")
</span><span class='line'>    @run_list.expand("_default", "disk")
</span><span class='line'>  end
</span><span class='line'>end</span></code></pre></td></tr></table></div></figure>


<p>こんなん書いてあった。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/usr/bin/env ruby
</span><span class='line'>
</span><span class='line'>require 'rubygems'
</span><span class='line'>require 'pp'
</span><span class='line'>require 'json'
</span><span class='line'>require 'chef/run_list'
</span><span class='line'>
</span><span class='line'>json_file = "./json/yoshimasa.json"
</span><span class='line'>
</span><span class='line'>host_config = JSON.parse(File.read(json_file))
</span><span class='line'>
</span><span class='line'>Chef::Config[:cookbook_path] = '/root/chef/cookbook/'
</span><span class='line'>Chef::Config[:role_path] = '/root/chef/json/'
</span><span class='line'>
</span><span class='line'>run_list = Chef::RunList.new("recipe[nginx]", "role[hoge]")
</span><span class='line'>
</span><span class='line'>p run_list
</span><span class='line'># #&lt;Chef::RunList:0x7f6fb8732510 @run_list_items=[#&lt;Chef::RunList::RunListItem:0x7f6fb87323d0 @type=:recipe, @version=nil, @name="nginx"&gt;, #&lt;Chef::RunList::RunListItem:0x7f6fb87323a8 @type=:role, @version=nil, @name="hoge"&gt;]&gt;
</span><span class='line'>
</span><span class='line'>pp run_list.expand("_default", "disk")
</span><span class='line'># #&lt;Chef::RunList::RunListExpansionFromDisk:0x7f6fb8732100
</span><span class='line'>#  @applied_roles={"hage"=&gt;true, "hoge"=&gt;true},
</span><span class='line'>#  @default_attrs={},
</span><span class='line'>#  @environment="_default",
</span><span class='line'>#  @missing_roles_with_including_role=[],
</span><span class='line'>#  @override_attrs={},
</span><span class='line'>#  @recipes=["nginx", "postfix", "yum"],
</span><span class='line'>#  @run_list_items=[],
</span><span class='line'>#  @run_list_trace=
</span><span class='line'>#   {"role[hoge]"=&gt;["role[hage]", "recipe[postfix]", "recipe[yum]"],
</span><span class='line'>#    "top level"=&gt;["recipe[nginx]", "role[hoge]"]},
</span><span class='line'>#  @source=nil&gt;
</span><span class='line'>
</span><span class='line'>p run_list.expand("_default", "disk").recipes
</span><span class='line'># ["nginx", "postfix", "yum"]</span></code></pre></td></tr></table></div></figure>


<p>こんな感じでrun_listを読める。何が便利かっていうと</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "run_list": [
</span><span class='line'>    "role[hage]"
</span><span class='line'>  ]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "run_list": [
</span><span class='line'>    "recipe[postfix]", "recipe[yum]"
</span><span class='line'>  ]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>run_list = Chef::RunList.new("recipe[nginx]", "role[hoge]")
</span><span class='line'>
</span><span class='line'>...
</span><span class='line'>p run_list.expand("_default", "disk").recipes
</span><span class='line'># ["nginx", "postfix", "yum"]</span></code></pre></td></tr></table></div></figure>


<p>という感じにroleの中のrun_listを読み込んでrecipesに突っ込んでくれる。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    <a href="/blog/archives">Blog Archives</a>
  </div>
</div>
<aside class="sidebar">
  
    
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - kenjiskywalker -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
